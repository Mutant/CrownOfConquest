<script>
var changes = false;
function addToGarrison(char_id) {
	dojo.byId('garrison-list-outer').style.display = 'block';
	
	moveChar(char_id, 'party-list','garrison-list', 'removeFromGarrison', 'Remove From Garrison');
}

function removeFromGarrison(char_id) {	
	moveChar(char_id, 'garrison-list', 'party-list','addToGarrison', 'Add To Garrison');
}

function moveChar(char_id, sourceTableId, destTableId, funcName, linkLabel) {
	changes = true;
	var sourceTable = dojo.byId(sourceTableId);
	
	var tableRow = dojo.byId('char_row_' + char_id);

	sourceTable.deleteRow(tableRow.rowIndex);

	var destTable = dojo.byId(destTableId);
	
	var insertRowIndex = 0;
	if (destTable.rows) {
		insertRowIndex = destTable.rows.length;
	}
	
	newRow = destTable.insertRow(insertRowIndex);
	newRow.innerHTML = tableRow.innerHTML;
	newRow.id = tableRow.id;
		
	lastCell = newRow.cells[newRow.cells.length-1];
	lastCell.innerHTML = '<a href="javascript:' + funcName + '(\'' + char_id + '\')">' + linkLabel + '</a>';
}

function postGarrisonForm() {
	if (dojo.byId('party-list').rows.length <= 1) {
		dojo.byId('error-message').innerHTML = 'You must keep a minimum of 1 character in your party.';
		dijit.byId('error').show();
		return;	
	}
	
	var rows = dojo.byId('garrison-list').rows;
	var charIds = Array();
	
	for(i=0; i<rows.length; i++) {
		if (rows[i].id) {			
			matchedId = rows[i].id.match(/\d+$/);
			charIds.push(matchedId[0]);
		}
	}
	
	if (charIds.length == 0) {
		dojo.byId('error-message').innerHTML = 'You must have a minimum of 1 character in the garrison.';
		dijit.byId('error').show();
		return;
	}
	
	var form = document.createElement("form");
    form.setAttribute("method", "post");
    form.setAttribute("action", "[% base %]garrison/[% IF garrison %]update[% ELSE %]add[% END %]");
    
    [% IF garrison %]
    	var hiddenField = document.createElement("input");
        hiddenField.setAttribute("type", "hidden");
        hiddenField.setAttribute("name", "garrison_id");
        hiddenField.setAttribute("value", "[% garrison.id %]");
        form.appendChild(hiddenField);        
	[% END %]    

    for(i=0; i<charIds.length; i++) {
        var hiddenField = document.createElement("input");
        hiddenField.setAttribute("type", "hidden");
        hiddenField.setAttribute("name", "chars_in_garrison");
        hiddenField.setAttribute("value", charIds[i]);        

        form.appendChild(hiddenField);
    }
    
	document.body.appendChild(form);
    form.submit();	
}
</script>