[% MACRO display_equipped_item(equipped_items, slot_orig) BLOCK %]
		[% slot = slot_orig %]
		<td dojoType="rpg.dnd.Target" id="[% slot %]-equip_place" accept="item" align="center" style="border: black 1px dashed" 
			width="50">
			[% item = equipped_items.$slot_orig %]
			<img src="[% IF item.item_type.image %][% c.config.static_path %]/images/items/[% item.item_type.image %][% END %]" id="[% slot %]-equip-place-image"
				style="[% IF ! item.item_type.image %]display: none[% END %]">
			<span id="[% slot %]-equip-place-text">[% IF ! item.item_type.image %][% item.item_type.item_type %][% END %]</span>
			<div dojoType="dijit.Tooltip"
                   connectId="[% slot %]-equip_place"
                   label="[% slot %]: [% FOREACH category IN equip_place_category_list.$slot_orig %][% category %][% UNLESS loop.last %], [% END %][% END %]"></div>
	        
	        <span id="[% slot %]-slot-label" [% IF item %]style="display: none"[% END %]>[% slot_orig %]</span>
		</td>
[% END %]

<table class="main" cellpadding="5">
	<tr>
		<td valign="top" width="250" style="background: lightgray">

<script>
	// Hack to get around dojo defeciency
	var currentItemId;
	function saveCurrentItemId(id) {
		console.log("Saving id " + id);
		parts = id.split(/-/);
		currentItemId = parts[2];
	}
</script>

<b>Equipped Items</b>

<br><br>

Mouse over an equipped item slot to see what types of items can be equipped there.

<br><br>

<div align="center">
	<table class="main">
		<tr>
			<td></td>
			[% display_equipped_item(equipped_items, 'Head') %]
			<td></td>
		</tr>
		<tr>
			[% display_equipped_item(equipped_items, 'Left Hand') %]
			[% display_equipped_item(equipped_items, 'Torso and Legs') %]
			[% display_equipped_item(equipped_items, 'Right Hand') %]
		</tr>	
	</table>
</div>

</td><td valign="top">

<b>Inventory</b>

<br><br>

[% IF character.party_id %]
	Mouse over an item to get it's stats. Drag an item onto an equip slot to the left to equip it. Alternatively, right click an 
	item to equip it, drop it, give it to another character. 
[% END %]

[% last_category = '' %]
[% FOREACH item IN items %]
	[%# Disabled for now to allow release to get out sooner rather than later %]
	[%# IF equipped_items_by_id.${item.id} %]
		[%# Don't display equipped items %]
		[%# NEXT %]
	[%# END %]

	[% IF last_category != item.item_type.category.item_category %]
		[% IF last_category != '' %]</div>[% END %]
		<div style="float: left; padding-right: 30px; padding-bottom: 10px"><h4 style="text-align: center">[% item.item_type.category.item_category %]</h4>
		[% last_category = item.item_type.category.item_category %]
	[% END %]

	[% IF character.party_id %]
	<span id="item-menu-[% item.id %]" onmouseover="saveCurrentItemId(this.id)">
		<span dojoType="dojo.dnd.Source" jsId="c1" class="source" copyOnly="true" id="item-connecter-[% item.id %]">
			<span class="dojoDndItem" dndType="item" id="item-[% item.id %]">
				<span id="item-tooltip-[% item.id %]">
				[% IF item.item_type.image %]
					<img src="[% c.config.static_path %]/images/items/[% item.item_type.image %]">
				[% ELSE %]
				[% item.display_name %]
				[% END %]
				</span>
			</span>
			<div dojoType="dijit.Tooltip"
           		connectId="item-tooltip-[% item.id %]"
           		id="item-dijit-[% item.id %]"
				style="display: none">
					[% INCLUDE item/tooltip_specific.html item=item, item_type=item.item_type %] 
            </div>
		</span>	
	</span>
	[% ELSE %]
		[% item.display_name %]
	[% END %]
[% END %]

<script>
function createMenus() { 

	var params = {id:"item_context_menu", 
		targetNodeIds:[[% FOREACH item IN items %]"item-menu-[% item.id %]"[% UNLESS loop.last %],[% END %][% END %]] };
	var menu = new dijit.Menu(params,document.createElement("div"));

	var equipSubMenu = new dijit.Menu();
	
	[% FOREACH equip_place IN equip_places %]
		params = {
			label: "[% equip_place %]",
			onClick: function(event) {
				console.log(event);
				equip_item('[% equip_place %]', currentItemId);
			}
		};
		
		var item = new dijit.MenuItem(params,document.createElement("div"));
		equipSubMenu.addChild(item);			
	[% END %]
	
	params = {
		label: "Equip Item In",
		popup: equipSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var equipPopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(equipPopupMenu);
	
	var giveSubMenu = new dijit.Menu();
	
	[% FOREACH char_in_party IN party.characters %]
		[% UNLESS char_in_party.character_id == character.id %]
			params = {
				label: "[% char_in_party.name %]",
				onClick: function() {
					give_item_to('[% char_in_party.id %]', currentItemId);
				}
			};
			
			var item = new dijit.MenuItem(params,document.createElement("div"));
			giveSubMenu.addChild(item);			
		[% END %]
	[% END %]
	
	params = {
		label: "Give Item To",
		popup: giveSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var givePopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(givePopupMenu);	
	
	params = {
		label: "Drop Item",
		onClick: function() {
			drop_item(currentItemId, '[% character.id %]');
		}
	};			
	var dropItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(dropItem);	
	
}

dojo.addOnLoad( createMenus );
</script>
</td></tr></table>