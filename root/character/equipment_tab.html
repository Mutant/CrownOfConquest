[% PROCESS equipment/grid.html %]
[% MACRO display_equipped_item(equipped_items, slot_orig) BLOCK %]
	[% equip_place = equip_places.$slot_orig %]
	[% item = equipped_items.$slot_orig %]
	<td id="equip_place_[% equip_place.id %]" class="equip-slot" align="center" style="border: #2F2F2F 1px dashed" 
		height="[% equip_place.height * 40 %]" width="[% equip_place.width * 40 %]" slotId="[% equip_place.id %]">
		[% IF item %]
			[% item_div("inventory", item) %]
		[% ELSE %]
			[% slot_orig %]
		[% END %]
	</td>
[% END %]

<script>
[% FOREACH slot_data IN equip_places %]
	[% slot = slot_data.value %] 
	$( "#equip_place_[% slot.id %]" ).droppable({
		accept: "[% FOREACH category IN equip_place_category_list.${slot.equip_place_name} %].[% category | lower | replace('\s+', '_') %]-category, [% END %]",
		drop: function( event, ui ) {
			dropItemOnEquipSlot(event, ui, $(this));
		},
		hoverClass: "item-droppable",			
	});
[% END %]

$( ".inventory-item" ).draggable({revert: "invalid"});

$( ".inventory" ).droppable({
	accept: ".inventory-item",
	drop: function( event, ui ) {
		dropItem(event, ui, $(this));
	},
			
	over: function(event, ui) {
		dragItemOver(event, ui, $(this));
	},
	
	out: function(event, ui) {
		dragItemOut(event, ui, $(this));
	}
	
});


	// Hack to get around dojo deficiency
	var currentItemId;
	function saveCurrentItemId(id) {
		currentItemId = id;
	}
	
function createItemMenus() {
	//createInventoryMenu(); 
	//createEquippedMenu();
	//createQuantityMenu();
}
	
function createInventoryMenu() { 
	if (dijit.byId('item_inventory_menu') != undefined) {
		dijit.byId('item_inventory_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (! item.equipped && ! item.quantity)
		  return true;
	}), function(item) { return item.id } ); 

	var params = {id:"item_inventory_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));
	
	var equipSubMenu = new dijit.Menu();
	
	[% FOREACH equip_place IN equip_places %]
		params = {
			label: "[% equip_place %]",
			onClick: function(event) {
				equip_item('[% equip_place %]', currentItemId);
			}
		};
		
		var item = new dijit.MenuItem(params,document.createElement("div"));
		equipSubMenu.addChild(item);			
	[% END %]
	
	params = {
		label: "Equip Item In",
		popup: equipSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var equipPopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(equipPopupMenu);
	
	addCommonMenuItems(menu);	
} 	

function createQuantityMenu() {
	if (dijit.byId('item_quantity_menu') != undefined) {
		dijit.byId('item_quantity_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (item.quantity)
		  return true;
	}), function(item) { return item.id } ); 
	
	var params = {id:"item_quantity_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));
	
	params = {
		label: "Split",
		onClick: function() {
			split_item(currentItemId);
		}
	};
	var splitItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(splitItem);
	
	addCommonMenuItems(menu);		
}

function createEquippedMenu() {
	if (dijit.byId('item_equipped_menu') != undefined) {
		dijit.byId('item_equipped_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (item.equipped)
		  return true;
	}), function(item) { return item.equipped + '-equip_place' } ); 

	var params = {id:"item_equipped_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));

	params = {
		label: "Unequip Item",
		onClick: function() {
			unequip_item(currentItemId, '[% character.id %]');
		}
	};			
	var dropItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(dropItem);
	
	addCommonMenuItems(menu);			
}

function addCommonMenuItems(menu) {
	var giveSubMenu = new dijit.Menu();

	[% FOREACH char_in_party IN allowed_to_give_to_characters %]
		[% UNLESS char_in_party.character_id == character.id %]
			params = {
				label: "[% char_in_party.name | html_entity %]",
				onClick: function() {
					give_item_to('[% char_in_party.id %]', currentItemId);
				}
			};
			
			var item = new dijit.MenuItem(params,document.createElement("div"));
			giveSubMenu.addChild(item);			
		[% END %]
	[% END %]

	params = {
		label: "Give Item To",
		popup: giveSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var givePopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(givePopupMenu);	

	params = {
		label: "Drop Item",
		onClick: function() {
			drop_item_diag(currentItemId, '[% character.id %]');
		}
	};			
	var dropItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(dropItem);	
}

</script>

<div style="background: black; margin: 0px; padding: 0px; height: 100%">

<div style="float: left">
	<b>Equipped Items</b>
	<br><br>
	<table class="main">
		<tr>
			<td></td>
			[% display_equipped_item(equipped_items, 'Head') %]
			<td></td>
		</tr>
		<tr>
			[% display_equipped_item(equipped_items, 'Left Ring Finger') %]
			[% display_equipped_item(equipped_items, 'Neck') %]
			[% display_equipped_item(equipped_items, 'Right Ring Finger') %]			
		<tr>
			[% display_equipped_item(equipped_items, 'Left Hand') %]
			[% display_equipped_item(equipped_items, 'Torso and Legs') %]
			[% display_equipped_item(equipped_items, 'Right Hand') %]
		</tr>	
	</table>
</div>

<div style="float: left; margin-left: 10px">

<b>Inventory</b>

[% create_grid('inventory', items_in_grid, 8, 14) %]

</div>