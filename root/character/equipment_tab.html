[% MACRO display_equipped_item(equipped_items, slot_orig) BLOCK %]
		[% slot = slot_orig %]
		[% item = equipped_items.$slot_orig %]
		<td dojoType="rpg.dnd.Target" id="[% slot %]-equip_place" 
			accept="[% FOREACH category IN equip_place_category_list.$slot_orig %][% category %][% UNLESS loop.last %],[% END %][% END %]"
			align="center" style="border: lightgray 1px dashed" 
			width="50">			
			<span id="[% slot %]-item-id" style="display: none">[% item.id %]</span>
			<span onMouseOver="saveCurrentItemId(dojo.byId('[% slot %]-item-id').innerHTML)">

			<img src="[% IF item.item_type.image %][% c.config.static_path %]/images/items/[% item.item_type.image %][% END %]" id="[% slot %]-equip-place-image"
				style="[% IF ! item.item_type.image %]display: none[% END %]"
				>
			<span id="[% slot %]-equip-place-text">[% IF ! item.item_type.image %][% item.item_type.item_type %][% END %]</span>			
			<div dojoType="dijit.Tooltip"
	           		connectId="[% slot %]-equip_place"
	           		id="[% slot %]-tooltip"
					style="display: none;">
						[% IF item %][% INCLUDE item/tooltip_specific.html item=item, item_type=item.item_type %][% END %] 
	        </div>	        
	        <span id="[% slot %]-slot-label" [% IF item %]style="display: none"[% END %]>[% slot_orig %]</span>
	        </span>
		</td>
[% END %]

<table class="main" cellpadding="5" height="100%">
	<tr>
		<td valign="top" width="250" style="
		border: 2px solid black;         
		-moz-border-radius: 10px;
        -webkit-border-radius: 10px;
        -khtml-border-radius: 10px;
        border-radius: 10px;">

<script>
	// Hack to get around dojo deficiency
	var currentItemId;
	function saveCurrentItemId(id) {
		currentItemId = id;
	}
	
function createItemMenus() {
	createInventoryMenu(); 
	createEquippedMenu();
	createQuantityMenu();
}
	
function createInventoryMenu() { 
	if (dijit.byId('item_inventory_menu') != undefined) {
		dijit.byId('item_inventory_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (! item.equipped && ! item.quantity)
		  return true;
	}), function(item) { return item.id } ); 

	var params = {id:"item_inventory_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));
	
	var equipSubMenu = new dijit.Menu();
	
	[% FOREACH equip_place IN equip_places %]
		params = {
			label: "[% equip_place %]",
			onClick: function(event) {
				equip_item('[% equip_place %]', currentItemId);
			}
		};
		
		var item = new dijit.MenuItem(params,document.createElement("div"));
		equipSubMenu.addChild(item);			
	[% END %]
	
	params = {
		label: "Equip Item In",
		popup: equipSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var equipPopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(equipPopupMenu);
	
	addCommonMenuItems(menu);	
} 	

function createQuantityMenu() {
	if (dijit.byId('item_quantity_menu') != undefined) {
		dijit.byId('item_quantity_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (item.quantity)
		  return true;
	}), function(item) { return item.id } ); 
	
	var params = {id:"item_quantity_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));
	
	params = {
		label: "Split",
		onClick: function() {
			split_item(currentItemId);
		}
	};
	var splitItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(splitItem);
	
	addCommonMenuItems(menu);		
}

function createEquippedMenu() {
	if (dijit.byId('item_equipped_menu') != undefined) {
		dijit.byId('item_equipped_menu').destroyRecursive();			
	}
	
	var itemIds = dojo.map(dojo.filter(itemMenuData, function(item) {
		if (item.equipped)
		  return true;
	}), function(item) { return item.equipped + '-equip_place' } ); 

	var params = {id:"item_equipped_menu", targetNodeIds:itemIds };

	var menu = new dijit.Menu(params,document.createElement("div"));

	params = {
		label: "Unequip Item",
		onClick: function() {
			unequip_item(currentItemId, '[% character.id %]');
		}
	};			
	var dropItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(dropItem);
	
	addCommonMenuItems(menu);			
}

function addCommonMenuItems(menu) {
	var giveSubMenu = new dijit.Menu();

	[% FOREACH char_in_party IN allowed_to_give_to_characters %]
		[% UNLESS char_in_party.character_id == character.id %]
			params = {
				label: "[% char_in_party.name %]",
				onClick: function() {
					give_item_to('[% char_in_party.id %]', currentItemId);
				}
			};
			
			var item = new dijit.MenuItem(params,document.createElement("div"));
			giveSubMenu.addChild(item);			
		[% END %]
	[% END %]

	params = {
		label: "Give Item To",
		popup: giveSubMenu,
		iconClass: "menuExpandIcon"
	};			
	var givePopupMenu = new dijit.PopupMenuItem(params);
	menu.addChild(givePopupMenu);	

	params = {
		label: "Drop Item",
		onClick: function() {
			drop_item(currentItemId, '[% character.id %]');
		}
	};			
	var dropItem = new dijit.MenuItem(params,document.createElement("div"));
	menu.addChild(dropItem);	
}

</script>

<b>Equipped Items</b>

<br><br><br><br>

<div align="center">
	<table class="main">
		<tr>
			<td></td>
			[% display_equipped_item(equipped_items, 'Head') %]
			<td></td>
		</tr>
		<tr>
			[% display_equipped_item(equipped_items, 'Left Hand') %]
			[% display_equipped_item(equipped_items, 'Torso and Legs') %]
			[% display_equipped_item(equipped_items, 'Right Hand') %]
		</tr>	
	</table>
</div>

</td><td valign="top">

<b>Inventory</b>

<br><br>

[% IF character.item_change_allowed %]
	Mouse over an item to get it's stats. Drag an item onto an equip slot to the left to equip it. Alternatively, right click an 
	item to equip it, drop it, or give it to another character.<br> 
[% END %]

<div dojoType="dojox.layout.ContentPane" href="[% base %]/character/inventory?character_id=[% character.id %]" 
	id="inventory-panel" [% IF character.item_change_allowed %]onDownloadEnd="createItemMenus()"[% END %] loadingMessage=""></div>

</td></tr></table>