[% IF window %]
	[% INCLUDE top.html %]
[% END %]

[% PROCESS layout/diag_buttons.html %]

<script type="text/javascript">
    function init() {
		[% IF group %]displayCharList('[% group %]');[% END %]
	}
	
	var inProgress = {};
	function equip_item(equip_place, item_id) {
		[%# Hack to get around the fact that the equip slots are defined each time the char screen loads %]
		if (inProgress[equip_place + ' ' + item_id]) {
			return;
		}
		inProgress[equip_place + ' ' + item_id] = true;
	
		dojo.xhrGet( {
	        url: "[% base %]/character/equip_item?item_id=" +  item_id + "&equip_place=" + equip_place,
	        handleAs: "json",
	        load: function(responseObject, ioArgs) {
	        	if (responseObject.error) {
       	          	dojo.byId('error-message').innerHTML = responseObject.error;
			      	dijit.byId('error').show();
	        	}
	        	else {
		        	var changed_slots = responseObject.changed_slots;
	        		for (changed_slot in changed_slots) {
	        			var item = changed_slots[changed_slot];
	        			dijit.byId(changed_slot + '-tooltip').label = item.tooltip; 
						dojo.byId(changed_slot + '-item-id').innerHTML = item.item_id; 
	        				        			  			
	        			if (item.image) {	        				
	        				dojo.byId(changed_slot + '-equip-place-image').style.display = 'block';
	        				dojo.byId(changed_slot + '-slot-label').style.display = 'none';
	        				dojo.byId(changed_slot + '-equip-place-image').src = '[% c.config.static_path %]/images/items/' + item.image;
	        				dojo.byId(changed_slot + '-equip-place-text').innerHTML = '';
	        			} 
	        			else if (item.text) {	        			
	        				dojo.byId(changed_slot + '-equip-place-image').style.display = 'none';
	        				dojo.byId(changed_slot + '-slot-label').style.display = 'none';
	        				dojo.byId(changed_slot + '-equip-place-image').src = '';
	        				dojo.byId(changed_slot + '-equip-place-text').innerHTML = item.item_type;
	        			}
	        			else {
       						clearEquipSlot(changed_slot);
	        			}
	        			reloadInventory();
	        			reloadStats();
	        			[% IF ! window %]getPanels('party/refresh_party_list');[% END %]
	        		}
				}
				
				inProgress[equip_place + ' ' + item_id] = false;
	        },
	        error: function(err) {
	        	console.debug(err);
	        	
	        	inProgress[equip_place + ' ' + item_id] = false;
	        }
	    });
	}
	
	function give_item_to(char_id, item_id) {
		dojo.xhrGet( {
	        url: "[% base %]/character/give_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
	        	reloadInventory();
	        	reloadStats();
	        	[% IF ! window %]getPanels('party/refresh_party_list');[% END %]	        	
	        	dojo.byId('encumbrance-value').innerHTML = responseObject.encumbrance;
				
				if (responseObject.clear_equip_place) {
					clearEquipSlot(responseObject.clear_equip_place);					
				}				
	        }
	    });	       
	}
	
	function drop_item_diag(item_id, char_id) {
		dojo.byId('drop-item-id').value = item_id;
		dojo.byId('drop-char-id').value = char_id;
		dijit.byId('drop-item-diag').show();
	}

	function drop_item(args) {
		var item_id = args.item_id;
		var char_id = args.char_id;
	
		dojo.xhrGet( {
	        url: "[% base %]/character/drop_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
	        	reloadInventory();
	        	reloadStats();
	        	[% IF ! window %]getPanels('party/refresh_party_list');[% END %]
				
				if (responseObject.clear_equip_place) {
					clearEquipSlot(responseObject.clear_equip_place);					
				}				
	        }
	    });	       
	}	
	
	function unequip_item(item_id, char_id) {
		dojo.xhrGet( {
	        url: "[% base %]/character/unequip_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
	        	reloadInventory();
	        	reloadStats();
	        	[% IF ! window %]getPanels('party/refresh_party_list');[% END %]
				clearEquipSlot(responseObject.clear_equip_place);
	        }
	    });	       
	}
	
	function split_item(item_id) {
		dojo.byId('split-item-id').value = item_id;
		dijit.byId('split-diag').show();
	}
	
	function split_item_submit(arguments) {
		dojo.xhrGet( {
	        url: "[% base %]/character/split_item?item_id=" +  arguments.item_id + "&new_quantity=" + arguments.new_quantity,
	        handleAs: "text",	
	        load: function(responseObject, ioArgs) {
	        	reloadInventory();
	        }
	    });	 	
	}
	
	
	dojo.addOnLoad( init );
	
function clearEquipSlot(slot_name) {
	dojo.byId(slot_name + '-equip-place-image').style.display = 'none';
	dojo.byId(slot_name + '-slot-label').style.display = 'block';
	dojo.byId(slot_name + '-equip-place-image').src = '';
	dojo.byId(slot_name + '-equip-place-text').innerHTML = '';	
	dijit.byId(slot_name + '-tooltip').label = ''; 
}	

function reloadInventory() {
     dojo.xhrGet({
         url: "[% base %]/character/inventory?character_id=[% character.id %]",
         load: function(data,ioa){
              dijit.byId('inventory-panel').setContent(data);
              createItemMenus();
         },
         timeout: 15000,
     });
}

function reloadStats() {
     dojo.xhrGet({
         url: "[% base %]/character/stats?character_id=[% character.id %]",
         load: function(data,ioa){
              dijit.byId('stats-panel').setContent(data);
         } 
     });
}

function addStatPoint(char_id, stat) {
	if (parseInt( dojo.byId('stat-points').innerHTML ) <= 0) {
		return;
	}

	dojo.xhrGet( {
        url: "[% base %]/character/add_stat_point?stat=" + stat + "&character_id=" + char_id,
        handleAs: "json",	
        load: function(responseObject, ioArgs) {
        	if (responseObject.error) {
   	          	dojo.byId('message-text').innerHTML = responseObject.error;
		      	dijit.byId('message').show();			
        	}
        	else {
        	    statValStr = dojo.byId('stat-' + stat).innerHTML;
        	    statValStr = statValStr.replace(/&nbsp;/,'');
        	    
        		statVal = parseInt( statValStr )+1;
        		
        		statVal = statVal + "";
        		if (statVal.length == 1) {
        			statVal = "&nbsp;" + statVal;
        		}
        		
        		dojo.byId('stat-points').innerHTML  = parseInt( dojo.byId('stat-points').innerHTML ) -1;
        		dojo.byId('stat-' + stat).innerHTML = statVal;
        		
        		[% IF ! window %]getPanels('party/refresh_party_list');[% END %]
        	}
        }
    });
}

function changeNameDiag(char_name, char_id) {
	dojo.byId('name-char-id').value = char_id;
	dojo.byId('character-name').value = char_name;
	dojo.byId('character-name').select();
	dijit.byId('change-name-diag').show();
}

function calculateSpellPoints() {
	inputs = dojo.byId('spells-form').getElementsByTagName('input');

	var points_used = 0;
	
	spell_id_regex = /^mem_tomorrow_(\d+)$/;
	
	for	(i=0; i<inputs.length; i++) {
		input = inputs[i];
						
		if (matches = spell_id_regex.exec(input.name)) {
			spell_id = matches[1];
			number_of_casts = input.value;
			
			spell_points = dojo.byId('spell_points_' + spell_id).innerHTML;
			
			points_used+= number_of_casts * spell_points;
		}
	}
	
	dojo.byId('spell-points-used').innerHTML = points_used;
}

$(function() {
	loadCharStats('[% character.id %]');
});

</script>

[% INCLUDE town/recruitment/dialog.html %]

<div dojoType="dijit.Dialog" id="message" style="display: none" title="Message">
    <span id="message-text"></span>
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>


<div dojoType="dijit.Dialog" id="split-diag" style="display: none" title="Split Item" execute="split_item_submit(arguments[0]);">
    Amount to split out: <input type="text" dojoType=dijit.form.TextBox name="new_quantity" value="1">
    <input id="split-item-id" name="item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none">
	[% dialog_buttons('split-diag') %]
</div>

<div dojoType="dijit.Dialog" id="change-name-diag" style="display: none" title="Change Character's Name">
	<form method="POST" action="[% base %]/character/change_name" onSubmit="postPanels(this); return false">
    Change Character's Name To: <input type="text" dojoType=dijit.form.TextBox id="character-name" name="new_name">
    <input id="name-char-id" name="character_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	[% dialog_buttons('change-name-diag') %]
	</form>
</div>

<div dojoType="dijit.Dialog" id="drop-item-diag" style="display: none" title="Drop Item Confirmation" execute="drop_item(arguments[0])">
	<input name="item_id" type="hidden" id="drop-item-id" dojoType=dijit.form.TextBox>
	<input name="char_id" type="hidden" id="drop-char-id" dojoType=dijit.form.TextBox>
    Are you sure you want to drop the item?<br>
    (Note, items dropped in town will disappear forever!)
	[% dialog_buttons('drop-item-diag') %]
	</form>
</div>

<div class="characterStats">

<img src="[% c.config.static_path %]/images/portraits/characters/[% character.portrait %].png" style="float: left">

<h1>
<span id="name-header">[% character.character_name %]</span>
[% IF ! window && ! character.town_id %]
	[% IF character.party_id %]<a href="javascript:changeNameDiag('[% character.character_name | replace("'","\\'") %]', '[% character.id %]')" class="main">Change</a>[% END %]
	<a href="[% base %]/character/view?character_id=[% character.id %]&window=1" target="_blank" class="main">Open in New Window</a>
[% END %]
</h1>


[% IF character.town_id %]
	[% IF can_buy %]<a href="javascript:confirmPurchase('[% character.character_name | replace("'","\\'") %]', '[% character.id %]', '[% character.value %]')">Buy</a> | [% END %]
	<a href="javascript:loadScreen('town/recruitment')">Back To Recruitment Office</a>
[% END %]

<div id="other-chars" style="margin-bottom: 3px">

[% MACRO character_links(type, characters, display) BLOCK %]
	<span id="character-list-[% type %]" [% UNLESS display %]style="display: none;"[% END %]>
	[% FOREACH other_character IN characters %]
		[% IF other_character.id == character.id %]
			[% other_character.name %]
		[% ELSE %]
			[% FILTER collapse %]
				[% IF window %]
				<a href="[% base %]/character/view?character_id=[% other_character.id %]&window=1&selected=[% selected %]">
					[% other_character.name %]</a>				
				[% ELSE %]
				<a href="javascript:loadScreen('character/view?character_id=[% other_character.id %]&selected=[% selected %]')">
					[% other_character.name %]</a>
				[% END %]
			[% END %]
		[% END %]
		&nbsp;
	[% END %]
	</span>
[% END %]

[% IF ! character.party_id %]
	<b>Other Characters Available to Recruit</b>:
	[% character_links(type, character_list, 1) %]
[% ELSE %]
	[%# Two passes due to order... could be fixed.. %]
	[% types = ['party', 'group', 'mayors', 'others'] %]
	<span id="other-char-links" 
		style="padding: 2px; margin-right: 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px; -khtml-border-radius: 5px; border-radius: 5px; 
			background: #5F5F5F;">
	[% FOREACH type IN types %]
		[% IF character_list.$type.size > 0 %]
			<a href="javascript:displayCharList('[% type %]')" id="character-list-link-[% type %]">[% type | ucfirst %]</a>
		[% END %]
	[% END %]
	</span>
	
	[% FOREACH type IN types %]
		[% IF character_list.$type.size > 0 %]
			[% character_links(type, character_list.$type) %]
		[% END %]
	[% END %]
[% END %]

</div>

<div id="stats-panel" class="characterStats" style="float: left"></div>

</div>
<div class="kingdomsTabContainer" dojoType="dijit.layout.TabContainer" style="height:400px;">
    <div dojoType="dojox.layout.ContentPane" title="Equipment" 
    	href="[% base %]/character/equipment_tab?character_id=[% character.id %]"
    	[% IF selected == 'equipment' %]selected="true"[% END %] parseOnLoad="true">    
    </div>

	[% IF ! window && (character.class.class_name == 'Mage' || character.class.class_name == 'Priest') %]
    <div dojoType="dijit.layout.ContentPane" title="Spells" 
    	href="[% base %]/character/spells_tab?character_id=[% character.id %]"
         [% IF selected == 'spells' %]selected="true"[% END %]>    
    </div>
    [% END %]
    
    [% IF ! window %]
    <div dojoType="dijit.layout.ContentPane" title="Skills" href="[% base %]/character/skills?character_id=[% character.id %]"
    	[% IF selected == 'skills' %]selected="true"[% END %]>
    </div>    
    [% END %]
    
    <div dojoType="dijit.layout.ContentPane" title="History" href="[% base %]/character/history_tab?character_id=[% character.id %]"
    	[% IF selected == 'history' %]selected="true"[% END %]>    
    </div>

</div>

[% IF window %]
	[% INCLUDE bottom.html %]
[% END %]