[% INCLUDE top.html %]

<script type="text/javascript">
	dojo.require("dojo.dnd.Source");
	dojo.require("dijit.Tooltip");
	dojo.require("dijit.layout.TabContainer");
	
	dojo.declare("rpg.dnd.Target", dojo.dnd.Target, {
        onDndDrop: function(source, nodes, copy){
				if(this.containerState == "Over"){ // dropping on us
					source.delItem('dojoUnique1'); // delete the copied item
			    }
			    this.onDndCancel();  // cleanup the drop state
		},
			 
		markupFactory: function(params, node){
		    params._skipStartup = true;
		    return new rpg.dnd.Target(node, params);
		},
		
    });
    
    function init() {	
		dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
			var t = dojo.dnd.manager().target;

			var item_data = source.getItem(nodes[0].id).data;

			tmp = t.node.id.split(/-/);
			var target_id = tmp[0];
			var target_type = tmp[1];

	   		order_val = nodes[0].id.split(/-/);
			var item_id = order_val[1];
			
			if (target_type == 'equip_place') {
				equip_item(target_id, item_id, item_data);
			}
			else if (target_type == 'char') {
				give_item(target_id, item_id);
			}			
		});
	}
	
	function equip_item(equip_place, item_id, item_data) {
		dojo.xhrGet( {
	        url: "[% base %]/character/equip_item?item_id=" +  item_id + "&equip_place=" + equip_place,
	        handleAs: "json",
	        load: function(responseObject, ioArgs) {
	        	console.log(responseObject);
	        	if (responseObject.error) {
       	          	dojo.byId('error-message').innerHTML = responseObject.error;
			      	dijit.byId('error').show();
	        	}
	        	else {
		        	console.log(item_data);
					console.log(equip_place);
					dojo.byId(equip_place + '-equip-place-item').innerHTML = item_data;
					
					if (responseObject.clear_equip_place) {
						dojo.byId(responseObject.clear_equip_place + '-equip-place-item').innerHTML = '';
					}
				}
	        },
	    });
	}
	
	function give_item(char_id, item_id) {
		dojo.xhrGet( {
	        url: "[% base %]/character/give_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
	        	if (responseObject.message) {
       	          	dojo.byId('message-text').innerHTML = responseObject.message;
       	          	dojo.byId('item-row-' + item_id).style.display = 'none';
			      	dijit.byId('message').show();					
	        	}
	        },
	    });	       
	}
	
	dojo.addOnLoad( init );	
	
function addStatPoint(char_id, stat) {
	if (parseInt( dojo.byId('stat-points').innerHTML ) == 0) {
		return;
	}

	dojo.xhrGet( {
        url: "[% base %]/character/add_stat_point?stat=" + stat + "&character_id=" + char_id,
        handleAs: "json",	
        load: function(responseObject, ioArgs) {
        	if (responseObject.message) {
   	          	dojo.byId('message-text').innerHTML = responseObject.message;
		      	dijit.byId('message').show();					
        	}
        	else {
        		statVal = parseInt( dojo.byId('stat-' + stat).innerHTML ) +1;
        		
        		statVal = statVal + "";
        		if (statVal.length == 1) {
        			statVal = "&nbsp;" + statVal;
        		}
        		
        		dojo.byId('stat-points').innerHTML  = parseInt( dojo.byId('stat-points').innerHTML ) -1;
        		dojo.byId('stat-' + stat).innerHTML = statVal;
        	}
        },
    });

}
</script>

<div dojoType="dijit.Dialog" id="message" style="display: none" title="Message">
    <span id="message-text"></span>
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>

<h1>[% character.character_name %]</h1>

<b>Party:</b>
[% FOREACH other_character IN characters %]
	[% IF other_character.id == character.id %]
		[% other_character.character_name %]
	[% ELSE %]
	<span dojoType="rpg.dnd.Target" id="[% other_character.id %]-char" accept="item">
	<a href="[% base %]/character/view?character_id=[% other_character.id %]">[% other_character.character_name %]</a>
	</span>
	[% END %]
[% END %]

<br><br>

<div class="aligned" id="character">

<div class="aligned-line">
    <span class="aligned-label">Race:</span>
    <span class="aligned-value">[% character.race.race_name %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Class:</span>
    <span class="aligned-value">[% character.class.class_name %]</span>
</div>


<div class="aligned-line">
    <span class="aligned-label">Level:</span>
    <span class="aligned-value">[% character.level %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Experience:</span>
    <span class="aligned-value">[% character.xp %] / [% xp_for_next_level %]</span>
</div>

</div>

<br>

<div id="mainTabContainer" dojoType="dijit.layout.TabContainer" style="height: 100%">
      <div dojoType="dijit.layout.ContentPane" title="Stats">
		<div class="aligned" id="character">
		
		[% FOREACH stat IN ['strength', 'intelligence', 'agility', 'divinity', 'constitution'] %]
		<div class="aligned-line">
		    <span class="aligned-label">[% stat | ucfirst %]:</span>
    		[% formatted_stat = character.$stat %]
		    [% IF character.$stat < 10 %]
		    	[% formatted_stat = '&nbsp;' _ character.$stat %]
		    [% END %]		     
		    <span class="aligned-value" id="stat-[% stat %]">[% formatted_stat %]</span>
		    <span>
		    	[% IF character.stat_points %]
		    		<input type="button" value="+" onClick="addStatPoint('[% character.id %]','[% stat %]')">
		    	[% END %]
		    </span>
		</div>
		[% END %]

		[% IF character.stat_points %]
		<br><br>
		<div class="aligned-line">
		    <span class="aligned-label">Stat Points:</span>
		    <span class="aligned-value" id="stat-points">[% character.stat_points %]</span>
		</div>			
		[% END %]
		
		<br>
		<div class="aligned-line">
		    <span class="aligned-label">Hit Points:</span>
		    <span class="aligned-value">[% character.hit_points %] / [% character.max_hit_points %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Spell Points:</span>
		    <span class="aligned-value">[% character.spell_points %]</span>
		</div>
		
		<br>
		<div class="aligned-line">
		    <span class="aligned-label">Attack Factor:</span>
		    <span class="aligned-value">[% character.attack_factor %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Defence Factor:</span>
		    <span class="aligned-value">[% character.defence_factor %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Damage:</span>
		    <span class="aligned-value">[% character.damage %]</span>
		</div>
		
		</div>
	</div>

	
    <div dojoType="dijit.layout.ContentPane" title="Equipment" href="[% based %]/character/equipment_tab?character_id=[% character.id %]">    
    </div>

	[% IF character.class.class_name == 'Mage' || character.class.class_name == 'Priest' %]
    <div dojoType="dijit.layout.ContentPane" title="Spells" href="[% based %]/character/spells_tab?character_id=[% character.id %]"
         [% IF selected == 'spells' %]selected="true"[% END %]>    
    </div>
    [% END %]



[% INCLUDE bottom.html %]