[% INCLUDE top.html %]

<script type="text/javascript">
	dojo.require("dojo.dnd.Source");
	dojo.require("dijit.Tooltip");
	dojo.require("dijit.layout.TabContainer");
	dojo.require("rpg.dnd.Target");
    
    function init() {	
		dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
			var t = dojo.dnd.manager().target;

			var item_data = source.getItem(nodes[0].id).data;

			tmp = t.node.id.split(/-/);
			var target_id = tmp[0];
			var target_type = tmp[1];

	   		order_val = nodes[0].id.split(/-/);
			var item_id = order_val[1];
			
			if (target_type == 'equip_place') {
				equip_item(target_id, item_id, item_data);
			}
			else if (target_type == 'char') {
				give_item(target_id, item_id);
			}			
		});
	}
	
	function equip_item(equip_place, item_id, item_data) {
		dojo.xhrGet( {
	        url: "[% base %]/character/equip_item?item_id=" +  item_id + "&equip_place=" + equip_place,
	        handleAs: "json",
	        load: function(responseObject, ioArgs) {
	        	console.log(responseObject);
	        	if (responseObject.error) {
       	          	dojo.byId('error-message').innerHTML = responseObject.error;
			      	dijit.byId('error').show();
	        	}
	        	else {
					dojo.byId(equip_place + '-equip-place-item').innerHTML = item_data;
					
					if (responseObject.clear_equip_place) {
						dojo.byId(responseObject.clear_equip_place + '-equip-place-item').innerHTML = '';
					}
				}
	        }
	    });
	}
	
	function give_item(char_id, item_id) {
		dojo.xhrGet( {
	        url: "[% base %]/character/give_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
				console.log(responseObject);
	        	if (responseObject.message) {
       	          	dojo.byId('message-text').innerHTML = responseObject.message;
       	          	dojo.byId('item-row-' + item_id).style.display = 'none';
			      	dijit.byId('message').show();					
	        	}
				
				if (responseObject.clear_equip_place) {
					dojo.byId(responseObject.clear_equip_place + '-equip-place-item').innerHTML = '';
				}
	        }
	    });	       
	}
	
	dojo.addOnLoad( init );	
	
function addStatPoint(char_id, stat) {
	if (parseInt( dojo.byId('stat-points').innerHTML ) <= 0) {
		return;
	}

	dojo.xhrGet( {
        url: "[% base %]/character/add_stat_point?stat=" + stat + "&character_id=" + char_id,
        handleAs: "json",	
        load: function(responseObject, ioArgs) {
        	if (responseObject.error) {
   	          	dojo.byId('message-text').innerHTML = responseObject.error;
		      	dijit.byId('message').show();			
        	}
        	else {
        	    statValStr = dojo.byId('stat-' + stat).innerHTML;
        	    statValStr = statValStr.replace(/&nbsp;/,'');
        	    
        		statVal = parseInt( statValStr )+1;
        		
        		statVal = statVal + "";
        		if (statVal.length == 1) {
        			statVal = "&nbsp;" + statVal;
        		}
        		
        		dojo.byId('stat-points').innerHTML  = parseInt( dojo.byId('stat-points').innerHTML ) -1;
        		dojo.byId('stat-' + stat).innerHTML = statVal;
        	}
        }
    });
}

function changeNameDiag(char_name, char_id) {
	dojo.byId('char-id').value = char_id;
	dojo.byId('character-name').value = char_name;
	dojo.byId('character-name').select();
	dijit.byId('change-name-diag').show();
}

function changeName(arguments) {
	if (! arguments.character_name) {
		return;
	}
	
	new_name = arguments.character_name;
	
	dojo.xhrGet( {
        url: "[% base %]/character/change_name?new_name=" + arguments.character_name + "&character_id=" + arguments.char_id,
        handleAs: "json",	
        load: function(responseObject, ioArgs) {
        	if (responseObject.error) {
   	          	dojo.byId('message-text').innerHTML = responseObject.error;
		      	dijit.byId('message').show();			
        	}
        	else {
				console.log(arguments.character_name);
        	    dojo.byId('name-header').innerHTML = new_name;
        	}
        }
    });	
}

function calculateSpellPoints() {
	inputs = dojo.byId('spells-form').getElementsByTagName('input');
	
	console.log("inputs: " + inputs.length);
	
	
	var points_used = 0;
	
	spell_id_regex = /^mem_tomorrow_(\d+)$/;
	
	for	(i=0; i<inputs.length; i++) {
		input = inputs[i];
						
		if (matches = spell_id_regex.exec(input.name)) {
			spell_id = matches[1];
			number_of_casts = input.value;
			
			spell_points = dojo.byId('spell_points_' + spell_id).innerHTML;
			
			points_used+= number_of_casts * spell_points;
		}
	}
	
	dojo.byId('spell-points-used').innerHTML = points_used;
}


</script>

<div dojoType="dijit.Dialog" id="message" style="display: none" title="Message">
    <span id="message-text"></span>
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>


<div dojoType="dijit.Dialog" id="change-name-diag" style="display: none" title="Change Character's Name" execute="changeName(arguments[0]);">
    Change Character's Name To: <input type="text" dojoType=dijit.form.TextBox id="character-name" name="character_name">
    <input id="char-id" name="char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	<br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button>
		<button dojoType=dijit.form.Button onclick="dijit.byId('change-name-diag').hide()">Cancel</button>
	</div>
</div>


<h1><span id="name-header">[% character.character_name %]</span> 
	[% IF character.party_id %]<a href="javascript:changeNameDiag('[% character.character_name %]', '[% character.id %]')" class="main">Change</a>[% END %]</h1>

[% IF character.town_id %]<a href="[% base %]/town/recruitment">Back To Recruitment Office</a><br><br>[% END %]

<b>[% IF character.party_id %]Party[% ELSE %]Other Characters Available to Recruit[% END %]:</b>
[% FOREACH other_character IN characters %]
	[% IF other_character.id == character.id %]
		[% other_character.character_name %]
	[% ELSE %]
	<span dojoType="rpg.dnd.Target" id="[% other_character.id %]-char" accept="item">
	<a href="[% base %]/character/view?character_id=[% other_character.id %]">[% other_character.character_name %]</a>
	</span>	
	[% END %]
	&nbsp;
[% END %]

<br><br>

<div class="aligned" id="character">

<div class="aligned-line">
    <span class="aligned-label">Race:</span>
    <span class="aligned-value">[% character.race.race_name %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Class:</span>
    <span class="aligned-value">[% character.class.class_name %]</span>
</div>


<div class="aligned-line">
    <span class="aligned-label">Level:</span>
    <span class="aligned-value">[% character.level %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Experience:</span>
    <span class="aligned-value">[% character.xp %] / [% xp_for_next_level %]</span>
</div>

</div>

<br>

<style>
	#mainTabContainer {height: 100%}
	
	* html #mainTabContainer {height: 700px; overflow: auto}
</style>

<div id="mainTabContainer" dojoType="dijit.layout.TabContainer">
      <div dojoType="dijit.layout.ContentPane" title="Stats" style="display: none">
		<div class="aligned" id="character">
		
		[% FOREACH stat IN ['strength', 'intelligence', 'agility', 'divinity', 'constitution'] %]
		<div class="aligned-line">
		    <span class="aligned-label">[% stat | ucfirst %]:</span>
    		[% formatted_stat = character.$stat %]
		    [% IF character.$stat < 10 %]
		    	[% formatted_stat = '&nbsp;' _ character.$stat %]
		    [% END %]		     
		    <span class="aligned-value" id="stat-[% stat %]">[% formatted_stat %]</span>
		    <span>
		    	[% IF character.stat_points %]
		    		<input type="button" value="+" onClick="addStatPoint('[% character.id %]','[% stat %]')">
		    	[% END %]
		    </span>
		</div>
		[% END %]

		[% IF character.stat_points %]
		<br><br>
		<div class="aligned-line">
		    <span class="aligned-label">Stat Points:</span>
		    <span class="aligned-value" id="stat-points">[% character.stat_points %]</span>
		</div>			
		[% END %]
		
		<br><br>
		<div class="aligned-line">
		    <span class="aligned-label">Hit Points:</span>
		    <span class="aligned-value">[% character.hit_points %] / [% character.max_hit_points %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Spell Points:</span>
		    <span class="aligned-value">[% character.spell_points %]</span>
		</div>
		
		<br><br>
		<div class="aligned-line">
		    <span class="aligned-label">Attack Factor:</span>
		    <span class="aligned-value">[% character.attack_factor %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Defence Factor:</span>
		    <span class="aligned-value">[% character.defence_factor %]</span>
		</div>

		<div class="aligned-line">
		    <span class="aligned-label">Damage:</span>
		    <span class="aligned-value">[% character.damage %]</span>
		</div>
		
		</div>
	</div>

	
    <div dojoType="dijit.layout.ContentPane" title="Equipment" href="[% base %]/character/equipment_tab?character_id=[% character.id %]">    
    </div>

	[% IF character.class.class_name == 'Mage' || character.class.class_name == 'Priest' %]
    <div dojoType="dijit.layout.ContentPane" title="Spells" href="[% base %]/character/spells_tab?character_id=[% character.id %]"
         [% IF selected == 'spells' %]selected="true"[% END %]>    
    </div>
    [% END %]
    
    <div dojoType="dijit.layout.ContentPane" title="History" href="[% base %]/character/history_tab?character_id=[% character.id %]">    
    </div>



[% INCLUDE bottom.html %]