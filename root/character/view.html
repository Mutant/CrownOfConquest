[% INCLUDE top.html %]

<script type="text/javascript">
	dojo.require("dojo.dnd.Source");
	
	dojo.declare("rpg.dnd.Target", dojo.dnd.Target, {
        onDndDrop: function(source, nodes, copy){
				if(this.containerState == "Over"){ // dropping on us
					source.delItem('dojoUnique1'); // delete the copied item
			    }
			    this.onDndCancel();  // cleanup the drop state
		},
			 
		markupFactory: function(params, node){
		    params._skipStartup = true;
		    return new rpg.dnd.Target(node, params);
		},
		
    });
    
    function init() {	
		dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
			var t = dojo.dnd.manager().target;

			var item_data = source.getItem(nodes[0].id).data;

			tmp = t.node.id.split(/-/);
			var target_id = tmp[0];
			var target_type = tmp[1];

	   		order_val = nodes[0].id.split(/-/);
			var item_id = order_val[1];
			
			if (target_type == 'equip_place') {
				equip_item(target_id, item_id, item_data);
			}
			else if (target_type == 'char') {
				give_item(target_id, item_id);
			}			
		});
	}
	
	function equip_item(equip_place, item_id, item_data) {
		dojo.xhrGet( {
	        url: "[% base %]/character/equip_item?item_id=" +  item_id + "&equip_place=" + equip_place,
	        handleAs: "json",
	        load: function(responseObject, ioArgs) {
	        	if (responseObject.error) {
       	          	dojo.byId('error-message').innerHTML = responseObject.error;
			      	dijit.byId('error').show();
	        	}
	        	else {
					dojo.byId(equip_place + '-equip-place-item').innerHTML = item_data;
					
					if (responseObject.clear_equip_place) {
						dojo.byId(responseObject.clear_equip_place + '-equip-place-item').innerHTML = '';
					}
				}
	        },
	    });
	}
	
	function give_item(char_id, item_id) {
		dojo.xhrGet( {
	        url: "[% base %]/character/give_item?item_id=" +  item_id + "&character_id=" + char_id,
	        handleAs: "json",	
	        load: function(responseObject, ioArgs) {
	        	if (responseObject.message) {
       	          	dojo.byId('message-text').innerHTML = responseObject.message;
			      	dijit.byId('message').show();					
	        	}
	        },
	    });	       
	}
	
	dojo.addOnLoad( init );	
</script>

<div dojoType="dijit.Dialog" id="message" style="display: none" title="Message">
    <span id="message-text"></span>
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>

<h1>[% character.character_name %]</h1>

<b>Party:</b>
[% FOREACH other_character IN characters %]
	[% IF other_character.id == character.id %]
		[% other_character.character_name %]
	[% ELSE %]
	<span dojoType="rpg.dnd.Target" id="[% other_character.id %]-char" accept="item">
	<a href="[% base %]/character/view?character_id=[% other_character.id %]">[% other_character.character_name %]</a>
	</span>
	[% END %]
[% END %]

<br><br>

<div class="aligned" id="character">

<div class="aligned-line">
    <span class="aligned-label">Race:</span>
    <span class="aligned-value">[% character.race.race_name %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Class:</span>
    <span class="aligned-value">[% character.class.class_name %]</span>
</div>

<div class="aligned-line">
    <span class="aligned-label">Experience:</span>
    <span class="aligned-value">[% character.xp %]</span>
</div>

</div>

<br>

<b>Equipped Items</b>

<br>

<table>
[% FOREACH equipped_item IN equipped_items %]
	<tr>
		<td dojoType="rpg.dnd.Target" id="[% equipped_item.key %]-equip_place" accept="item">[% equipped_item.key %]</td>
		<td id="[% equipped_item.key %]-equip-place-item">[% equipped_item.value.item_type.item_type %]</td>
	</tr>
[% END %]
</table>

<b>All Items</b>

<br>

<table>
[% last_category = '' %]
[% FOREACH item IN character.items %]
	[% IF last_category != item.item_type.category.item_category %]
		<tr><td colspan="2"><b>[% item.item_type.category.item_category %]</b></td></tr>
		[% last_category = item.item_type.category.item_category %]
	[% END %]
	<tr>
		<td>
			<span dojoType="dojo.dnd.Source" jsId="c1" class="source" copyOnly="true">
				<span class="dojoDndItem" dndType="item" id="item-[% item.id %]" dndData="[% item.item_type.item_type %]">[% item.item_type.item_type %]</span>
			</span>	
		</td>
	</tr>
[% END %]
</table>

[% INCLUDE bottom.html %]