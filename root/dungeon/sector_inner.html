[% FILTER collapse %]
	[% IF sector %]
		[% border = "" %]
		[% sides_with_walls = sector.sides_with_walls %]
		[% FOREACH side IN positions  %]
			[% border_color = "#000" %]
			[% FOREACH side_with_wall IN sides_with_walls %]
				[% IF side_with_wall == side %]
					[% border_color = "#9F9F9F" %]
				[% END %]
			[% END %]				
		
			[% border = border _ "border-" _ side _ ": 1px solid " _  border_color _ "; " %]
		[% END %] 
		
		[% can_move_to_sector = 0 %]
		[% IF allowed_to_move_to.${sector.dungeon_grid_id} && ! in_combat %]
			[% can_move_to_sector =  1 %]
		[% END %]
		
		[% IF can_move_to_sector %]
			<a href = "javascript:getPanels('/[% dungeon_type %]/move_to?sector_id=[% sector.dungeon_grid_id %]')" 
				style="text-decoration: none;">
		[% END %]
		
		[% IF sector.stairs_up %]
			[% background_image = "dungeonstairsup1.png" %]
		[% ELSIF sector.stairs_down %]
			[% background_image = "dungeonstairsdown1.png" %]
		[% ELSE %]
			[% number = 1 %]
			[% IF x % 4 == 0 && y % 3 == 0 %]
				[% number = 2 %]
			[% END %]
			[% IF x % 6 == 0 && y % 5 == 0 %]
				[% number = 3 %]
			[% END %]
			[% IF x % 8 == 0 && y % 6 == 0 %]
				[% number = 3 %]
			[% END %]
			[% background_image = 'dungeonfloor' _ number _ '.png' %] 
		[% END %]					
	
		<div style="
			[% border %]
			width: [% size %]px; 
			height: [% size %]px; 
			position: absolute;
			background-image: url('[% c.config.static_path %]/images/dungeon/[% background_image %]');
			font-size: [% size / 2 %]px;
			text-align: center;			
			"
			>
									
			[% IF ! viewable_sectors.$x.$y && current_location.id != sector.dungeon_grid_id %]
				<span style="z-index: 60; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/dungeonshroud.png" border=0 width=[% size %] height=[% size %]></span>
			[% END %]
									
			[% IF sector.treasure_chest %]
				<img src="[% c.config.static_path %]/images/dungeon/treasure_chest.png" border=0  width=[% size %] height=[% size %]>
			[% ELSIF sector.teleporter && ! sector.teleporter.invisible %]
				<img src="[% c.config.static_path %]/images/dungeon/teleporticon.png" border=0  width=[% size %] height=[% size %]>				
			[% END %]
			
			[% IF cgs.$x.$y %]
				<span id="m_[% x _ y %]" style="z-index: 40; position: absolute; top: 0px; left: 0px;"><div style="position: relative; left: 3px; top: 2px"><img src="[% c.config.static_path %]/images/creatures/[% cgs.$x.$y.portrait %]" border=0 width=[% size / 1.2 %] height=[% size / 1.2 %]></div></span>
			    [% IF create_tooltips %]
			    <div 
					dojoType="dijit.Tooltip" 
					connectId="m_[% x _ y %]"								
					label="[% INCLUDE combat/creature_group_summary.html creature_group=cgs.$x.$y %]"></div>
				[% END %]
			[% ELSIF parties.$x.$y %]
				<span id="p_[% x _ y %]" style="z-index: 40; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/party.PNG" border=0  width=[% size %] height=[% size %]></span>
			    [% IF create_tooltips %]
			    <div 
					dojoType="dijit.Tooltip" 
					connectId="p_[% x _ y %]"
					label="[% INCLUDE party/summary.html party=parties.$x.$y %]"></div>
				[% END %]
			[% ELSIF can_move_to_sector %]
			    <span style="z-index: 100; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; text-align: center; margin: 0px auto">.</span>
			[% END %]
			
			[% IF current_location.id == sector.dungeon_grid_id %]
				<span style="z-index: 50; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/partyloc_t.PNG" border=0  width=[% size %] height=[% size %]></span>
			[% END %]			
			
			</div>
			
			[% IF can_move_to_sector %]</a>[% END %]	
			
			[% FOREACH door IN sector.doors %]
				[% IF door.type != 'secret' || door.state == 'open' %]
			
					[% left_offset = 0 %]
					[% width_offset = 0 %]
					[% top_offset = 0 %]
					[% height_offset = 0 %]
					[% position = door.position.position %]
				
					[% IF position == 'right' ||  position == 'left' %]
						[% height = door_length %]
						[% width = door_thickness %]
						[% height_offset = 2 %]
					[% ELSE %]
						[% height = door_thickness %]
						[% width = door_length %]
						[% width_offset = 2 %]
					[% END %]
				
					[% IF position == 'right' %]
						[% left_offset = 1 %]
						[% width_offset = 0 - width + 1 %]
					[% ELSIF position == 'left' %]
						[% left_offset = 0 %]
						[% width_offset = 1 %]
					[% ELSIF position == 'bottom' %]
						[% top_offset = 1 %]
						[% height_offset = 0 - height + 1 %]
					[% END %]
					
	         		<div 
					   style="
						position: absolute;
						width: [% width %];
						height: [% height %];
						background: #9F9F9F;
						left: [% left_offset * size + width_offset %];
						top: [% top_offset * size + height_offset %];"
					>					
					</div>			
				[% END %]			
			[% END %]
	[% END %]
[% END %]