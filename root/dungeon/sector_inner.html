[% FILTER collapse %]
	[% IF sector %]
		[% border = "" %]
		[% sides_with_walls = sector.sides_with_walls %]
		[% FOREACH side IN positions  %]
			[% border_color = "#000" %]
			[% FOREACH side_with_wall IN sides_with_walls %]
				[% IF side_with_wall == side %]
					[% border_color = "#9F9F9F" %]
				[% END %]
			[% END %]				
		
			[% border = border _ "border-" _ side _ ": 1px solid " _  border_color _ "; " %]
		[% END %] 
		
		[% can_move_to_sector = 0 %]
		[% IF allowed_to_move_to.${sector.dungeon_grid_id} && ! in_combat %]
			[% can_move_to_sector =  1 %]
		[% END %]
		
		[% IF can_move_to_sector %]
			<a href = "javascript:getPanels('/[% dungeon_type %]/move_to?sector_id=[% sector.dungeon_grid_id %]')" 
				style="text-decoration: none;">
		[% END %]
		
		[% IF sector.stairs_up %]
			[% background_image = "d" _ tileset _ "us.png" %]
		[% ELSIF sector.stairs_down %]
			[% background_image = "d" _ tileset _ "ds.png" %]
		[% ELSE %]
			[% background_image = 'd' _ tileset _ sector.tile _ '.png' %] 
		[% END %]					
	
		<div style="
			[% border %]
			width: [% size %]px; 
			height: [% size %]px; 
			position: absolute;
			background-image: url('[% c.config.static_path %]/images/dungeon/[% background_image %]');
			font-size: [% size / 2 %]px;
			text-align: center;			
			"
			>
									
			[% IF ! viewable_sectors.$x.$y && current_location.id != sector.dungeon_grid_id %]
				<span style="z-index: 60; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/shroud.png" border=0 width=[% size %] height=[% size %]></span>
			[% END %]
									
			[% IF sector.treasure_chest %]
				<img src="[% c.config.static_path %]/images/dungeon/treasure_chest.png" border=0  width=[% size %] height=[% size %]>
			[% ELSIF sector.teleporter && ! sector.teleporter.invisible %]
				<img src="[% c.config.static_path %]/images/dungeon/teleporticon.png" border=0  width=[% size %] height=[% size %]>	
			[% ELSE %]
				[% IF sector.overlay == 'skeleton' %]
					<img src="[% c.config.static_path %]/images/dungeon/dungeonskeleton.png" border=0  width=[% size %] height=[% size %]>
				[% END %]
			[% END %]
			
			[% IF cgs.$x.$y %]
				[% group_img = cgs.$x.$y.group_img %]
				<span id="m_[% x _ y %]" style="z-index: 40; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/[% group_img %][% cgs.$x.$y.group_size %].png" border=0 width=[% size %] height=[% size %]></span>
			    [% IF create_tooltips %]
			    <div 
					dojoType="dijit.Tooltip" 
					connectId="m_[% x _ y %]">
					[% INCLUDE combat/creature_group_summary.html creature_group=cgs.$x.$y %]
				</div>
				[% END %]
			[% ELSIF bombs.$x.$y %]
				<span id="b_[% x _ y %]" style="z-index: 40; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/bombrune.png" border=0 width=[% size %] height=[% size %]></span>
			[% ELSIF parties.$x.$y.0 %]
				[%# TODO: handle multiple parties in a sector %]
			    [% other_party = parties.$x.$y.0 %]
				<span id="p_[% x _ y %]" style="z-index: 40; position: absolute; top: 0px; left: 0px;"><div style="position: relative; left: [% size / 4 %]px; top: [% size / 4 %]px"><img src="[% c.config.static_path %]/images/dungeon/humanoid[% other_party.portrait %].png" border=0 width=[% size / 2 %] height=[% size / 2 %]></div></span>
			    [% IF create_tooltips %]
			    <div 
					dojoType="dijit.Tooltip" 
					connectId="p_[% x _ y %]">
					[% INCLUDE party/summary.html party=other_party %]
				</div>
				[% END %]
			[% ELSIF can_move_to_sector %]
			    <span style="z-index: 100; position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; text-align: center; margin: 0px auto">
			    		<img src="[% c.config.static_path %]/images/dungeon/movedot.png" border=0  width=[% size %] height=[% size %]>
			    </span>
			[% END %]
			
			[% IF current_location.id == sector.dungeon_grid_id %]
				<span style="z-index: 50; position: absolute; top: 0px; left: 0px;"><img src="[% c.config.static_path %]/images/dungeon/herecircle.png" border=0  width=[% size %] height=[% size %]></span>
			[% END %]			
			
			</div>
			
			[% IF can_move_to_sector %]</a>[% END %]	
			
			[% FOREACH door IN sector.doors %]
				[% IF door.type != 'secret' || door.state == 'open' %]
			
					[% left_offset = 0 %]
					[% width_offset = 0 %]
					[% top_offset = 0 %]
					[% height_offset = 0 %]
					[% position = door.position.position %]
				
					[% IF position == 'right' ||  position == 'left' %]
						[% height = door_length %]
						[% width = door_thickness %]
						[% height_offset = 2 %]
					[% ELSE %]
						[% height = door_thickness %]
						[% width = door_length %]
						[% width_offset = 2 %]
					[% END %]
				
					[% IF position == 'right' %]
						[% left_offset = 1 %]
						[% width_offset = 0 - width + 1 %]
					[% ELSIF position == 'left' %]
						[% left_offset = 0 %]
						[% width_offset = 1 %]
					[% ELSIF position == 'bottom' %]
						[% top_offset = 1 %]
						[% height_offset = 0 - height + 1 %]
					[% END %]
					
	         		<div 
					   style="
						position: absolute;
						width: [% width %]px;
						height: [% height %]px;
						background: #9F9F9F;
						left: [% left_offset * size + width_offset %]px;
						top: [% top_offset * size + height_offset %]px;"
					>					
					</div>			
				[% END %]			
			[% END %]
	[% END %]
[% END %]