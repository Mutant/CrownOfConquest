[%
	x = min_x - 1;
	y = min_y - 1;
	size = 30;
	door_thickness = size / 10;
	door_length = size - 4;
	
	scroll_to_x = current_location.x + 6;
%]	
	[% IF scroll_to_x > max_x %]
		[% scroll_to_x = max_x %]
	[% END %]
[%	
	scroll_to_y = current_location.y + 4; 
%]
	[% IF scroll_to_y > max_y %]
		[% scroll_to_y = max_y %]
	[% END %]

<div style="position: relative">
[% WHILE y <= max_y %]
	[% y = y+1 %]
	[% x = min_x - 1 %]
	[% WHILE x <= max_x %]
		[% FILTER collapse %]
			[% x = x+1 %]
			[% sector = grid.$x.$y %]
			[% IF sector %]
				[% border = "" %]
				[% sides_with_walls = sector.walls %] 
				[% FOREACH side IN positions  %]
					[% border_color = "white" %]
					[% FOREACH side_with_wall IN sides_with_walls %]
						[% IF side_with_wall == side %]
							[% border_color = "black" %]
						[% END %]
					[% END %]				
				
					[% border = border _ "border-" _ side _ ": 1px solid " _  border_color _ "; " %]
				[% END %] 
				
				[%
					current_x = sector.x
					current_y = sector.y
				%]					
					
				[% IF allowed_to_move_to.$current_x.$current_y && ! in_combat %]
					[% can_move_to_sector =  1 %]
				[% END %]
			
				[% IF can_move_to_sector %]
					<a href = "javascript:getPanels('/dungeon/move_to?sector_id=[% sector.dungeon_grid_id %]')" style="text-decoration: none;">
				[% END %]
				<div style="
				    [% border %] 
					width: [% size - 2 %]px; 
					height: [% size - 2 %]px; 
					position: absolute;
					left: [% (sector.x - min_x) * size %]; 
					top: [% (sector.y - min_y) * size %];
					background: [% IF current_location.id == sector.dungeon_grid_id %]lightblue[% ELSE %]white[% END %];
					font-size: [% size / 2 %]px;
					text-align: center"
					[% IF scroll_to_x == sector.x && scroll_to_y == sector.y %]id="scroll-to"[% END %]
					>
						[% IF sector.stairs_up %]
							S
						[% ELSIF cgs.$x.$y %]
						    M
						[% ELSIF can_move_to_sector %]
						    .
						[% ELSE %]
							<!--[% sector.x %], [% sector.y %]-->
						[% END %]
					</div>
					
					[% IF can_move_to_sector %]</a>[% END %]
					
					[% FOREACH door IN sector.doors %]
						[% left_offset = 0 %]
						[% width_offset = 0 %]
						[% top_offset = 0 %]
						[% height_offset = 0 %]
						[% position = door %]
					
						[% IF position == 'right' ||  position == 'left' %]
							[% height = door_length %]
							[% width = door_thickness %]
							[% height_offset = 2 %]
						[% ELSE %]
							[% height = door_thickness %]
							[% width = door_length %]
							[% width_offset = 2 %]
						[% END %]
					
						[% IF position == 'right' %]
							[% left_offset = 1 %]
							[% width_offset = 0 - width %]
						[% ELSIF position == 'left' %]
							[% left_offset = 0 %]
							[% width_offset = 1 %]
						[% ELSIF position == 'bottom' %]
							[% top_offset = 1 %]
							[% height_offset = 0 - height %]
						[% END %]
						
		         		<div 
						   style="
							position: absolute;
							width: [% width %];
							height: [% height %];
							background: black;
							left: [% ((sector.x - min_x) + left_offset) * size + width_offset %];
							top: [% ((sector.y - min_y) + top_offset) * size + height_offset %];"
						>&nbsp;</div>
					[% END %]
			[% ELSE %]
				<div style="
					left: [% (x - min_x) * size %]; 
					top: [% (y - min_y) * size %];
					width: [% size - 2 %]px; 
					height: [% size - 2 %]px; 					
					position: absolute;
				"
				[% IF scroll_to_x == x && scroll_to_y == y %]id="scroll-to"[% END %]
				></div>
			[% END %]
		[% END %]
	[% END %]	
[% END %]

</div>
