[% INCLUDE top.html, width="1045" %]

<script>
	dojo.require("dijit.layout.TabContainer");
	
	var mapBoxInit;
	var kingdomMapHidden = false;
	var mapBoxLoaded = false;
	
	function refreshMap(x,y,zoom_level) {
	
		var url = "[% base %]/map/party_inner?center_x=" + x + "&center_y=" + y + "&zoom_level=" + zoom_level;
		
		dojo.xhrGet( {
        	url: url,
        	handleAs: "json",
        
	        load: function(responseObject) {
				dijit.byId("inner-map").setContent(responseObject.inner);	
				
				if (mapBoxLoaded) {
					setMapBox(responseObject.map_box_coords);
				}
				else {
					[%# Kingdom map not loaded yet. Store mapBox details for a callback ~%]
					mapBoxInit = responseObject.map_box_coords;	
				}
			},
			timeout: 15000	
        });
	}
	
	var boxedCoords = [];
	function setMapBox(mapBoxCoords) {
		for (i = 0; i <= boxedCoords.length; i++) {		
			old = boxedCoords[i];
			if (old) {
				dojo.byId(old.sector).style.background = old.color;
			}
		}
		
		boxedCoords = [];
		
		var top_x = parseInt(mapBoxCoords.top_x);
		var top_y = parseInt(mapBoxCoords.top_y);
		var bottom_x = (parseInt(mapBoxCoords.top_x)+parseInt(mapBoxCoords.x_size));		
		var bottom_y = (parseInt(mapBoxCoords.top_y)+parseInt(mapBoxCoords.y_size));
		
		for (x = 0; x <= mapBoxCoords.x_size; x++) {
			for (y = 0; y <= mapBoxCoords.y_size; y++) {
				var sec_x = x+top_x;
				var sec_y = y+top_y;
			
				if ((sec_x != mapBoxCoords.top_x && sec_x != bottom_x) && (sec_y != mapBoxCoords.top_y && sec_y != bottom_y)) {					
					continue;   
				}

				var sector = dojo.byId('k-' + sec_x + '-' + sec_y);
				if (sector) {
					boxedCoords.push(
						{
							sector: 'k-' + sec_x + '-' + sec_y,
							color: sector.style.background
						}
					);

					sector.style.background = 'red';
				}
			}
		}
	}
	
	function init() {
		refreshMap('','','');
		
		[%# We do this here so it starts *after* the inner map begins loadings ~%] 
		dijit.byId("kingdom-map").href = "[% base %]/map/kingdom";
		dijit.byId("kingdom-map").refresh();
	}
	
	function initMapBox() {
		setMapBox(mapBoxInit);
		mapBoxLoaded = true;
	}
	
	function hideKingdomMap() {
		dojo.byId('kingdom-map-table').style.display = 'none';
		dojo.byId('hide-kingdom-map-link').style.display = 'none';
		dojo.byId('show-kingdom-map-link').style.display = 'inline';
		dojo.byId('kingdom-map').style.height = '30px';
		kingdomMapHidden = true;
	}
	
	function showKingdomMap() {
		dojo.byId('kingdom-map-table').style.display = 'block';
		dojo.byId('hide-kingdom-map-link').style.display = 'inline';
		dojo.byId('show-kingdom-map-link').style.display = 'none';
		dojo.byId('kingdom-map').style.height = '230px';
		kingdomMapHidden = false;
	}
	
	dojo.addOnLoad( init );
</script>

<div style="position: relative; height: 100%">

	<div style="position: relative">

		<div style="background: black; position: relative; overflow: auto; min-height: 760px" 
			dojoType="dijit.layout.ContentPane" id="inner-map">
		</div>

		<br><br>
		
		<center>Click on a square to centre the map there</center>
		

	</div>
	
	<div style="position: absolute; top: 0px; left: 0px; z-index: 100; background: white; width: 200px; height: 230px; border: 2px solid black; overflow: hidden" 
		dojoType="dijit.layout.ContentPane" id="kingdom-map" onDownloadEnd="initMapBox">
	
	</div>	
</div>
		



[% INCLUDE bottom.html %]