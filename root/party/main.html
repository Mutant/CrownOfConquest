[% INCLUDE top.html main_screen = 1 %]

<script>
function init() {
	var loadPanel = '[% load_panel %]';
	if (loadPanel) {
		getPanels(loadPanel);
	}
	
	var scrollTo = dojo.byId('scroll_to');

	if (scrollTo) {
		dijit.scrollIntoView(scrollTo.innerHTML);
	}
}

function dungeonScroll(scroll_to) {
	scroll_to_sector = 'sector_' + scroll_to.x + "_" + scroll_to.y;
	loc = dojo.byId(scroll_to_sector);
	if (loc) {
		dijit.scrollIntoView(loc);
	}
}

dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
	if (! nodes[0].id.match('^char-') && nodes[0].id != 'rank_separator') {
		return;
	}

	var t = dojo.dnd.manager().target;

	order_val = t.current.id.split(/-/);
	var char_2 = order_val[1];

	var drop_pos;
	(t.before == true) ? drop_pos='before' : drop_pos='after';
	
	if (nodes[0].id == 'rank_separator') {
    	dojo.xhrGet( {
	        url: "[% base %]/party/move_rank_separator?target=" + char_2 + "&drop_pos=" + drop_pos, 
	        handleAs: "text",

    	    timeout: 5000 // Time in milliseconds	
        });			
	}
	else {
    	order_val = nodes[0].id.split(/-/);
		var char_1 = order_val[1];
		
    	dojo.xhrGet( {
	        url: "[% base %]/party/swap_chars?moved=" + char_1 + "&target=" + char_2 + "&drop_pos=" + drop_pos, 
	        handleAs: "text",

    	    timeout: 5000 // Time in milliseconds	
        });
    }
});

dojo.addOnLoad( init );

/* From healer panel */
function healParty(dialogFields) {
	getPanels('/town/heal_party?gold=' + dialogFields.heal_amount);
}

function findTown(dialogFields) {
	getPanels("/town/sage/find_town?town_name=" + dialogFields.town_name + "&find_type=" + dialogFields.find_type);
}

function findItem(dialogFields) {
	getPanels("/town/sage/find_item?item_type_to_find=" + dialogFields.item_type_to_find);
}

function findDungeon(dialogFields) {
	getPanels("/town/sage/find_dungeon?find_level=" + dialogFields.find_level);
}

function disarmTrap(dialogFields) {
	getPanels("/dungeon/disarm_trap");
}

function checkAttack(creatureGroupId, confirmAttack, in_dungeon) {
	if (confirmAttack == 1) {
		dojo.byId('creature-group-id').value = creatureGroupId;
		dijit.byId('confirm-attack').show();
	}
	else {
		prefix = '';
		if (in_dungeon) {
			prefix = '/dungeon';
		}
		
		getPanels(prefix + '/combat/party_attacks?creature_group_id=' + creatureGroupId);
	}
}

function execConfirmedAttack(dialogFields) {
	getPanels('/combat/party_attacks?creature_group_id=' + dialogFields.creature_group_id);
}

function buryDiag(char_name, char_id) {
	dojo.byId('bury-message').innerHTML = "Are you sure you want to bury " + char_name + "?";
	dojo.byId('char-id').value = char_id;
	dijit.byId('confirm-bury').show();
}

function bury(dialogFields) {
	getPanels('/character/bury?character_id=' + dialogFields.char_id + '&epitaph=' + dialogFields.epitaph);
}

function enterTown(land_id, gold_cost, turn_cost) {
	dojo.byId('enter-town-text').innerHTML = "You must pay the daily tax to enter this town.<br><br>You can either pay " + gold_cost 
		+ " gold, or work for the town for " + turn_cost + " turns.";
	dojo.byId('land-id').value = land_id;
	dijit.byId('town-tax').show();
}

function enterTownSubmit(land_id, paymentMethod){
	getPanels('/town/enter?land_id=' + land_id + "&payment_method=" + paymentMethod);
	dijit.byId('town-tax').hide();
}

function confirmRaidTown(town_name, town_id) {
	dojo.byId('raid-town-text').innerHTML = "Are you sure you want to raid " + town_name + "?";
	dojo.byId('town-id').value = town_id;
	dijit.byId('town-raid').show();	
}

function raidTown(dialogFields){
	getPanels('/town/raid?town_id=' + dialogFields.town_id);
}

function unblockDoorDiag(direction, door_id) {
	dojo.byId('unblock-door-direction').innerHTML = direction;
	dojo.byId('door-id').value = door_id;
	dijit.byId('unblock-door-diag').show();
}

function unblockDoor(action) {
	dijit.byId('unblock-door-diag').hide();
	getPanels('/dungeon/unblock_door?door_id=' + dojo.byId('door-id').value + '&character_id=' + dojo.byId('character-id').value + '&action=' + action);
}

</script>

[% IF created_message %]
<script>
	function displayCreatedMessage() { dijit.byId('created-message').show() }
	dojo.addOnLoad(displayCreatedMessage);
</script>

<div dojoType="dijit.Dialog" id="created-message" style="display: none" title="Welcome To Kingdoms" execute="">
    [% created_message %]
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button>
	</div>
</div>
[% END %]

<div dojoType="dijit.Dialog" id="dialog" style="display: none" title="Dialog">
	<div id="dialog-content"></div>
</div>


<div dojoType="dijit.Dialog" id="confirm-attack" style="display: none" title="Confirm Attack" execute="execConfirmedAttack(arguments[0]);">
    <span id="confirmation-message">Are you sure you want to attack these creatures? They look pretty tough!</span>
    <input id="creature-group-id" name="creature_group_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	<br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button> 
		<button dojoType=dijit.form.Button onclick="dijit.byId('confirm-attack').hide()">Cancel</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="confirm-bury" style="display: none" title="Bury Character" execute="bury(arguments[0]);">
    <input id="char-id" name="char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	<span id="bury-message"></span>
	<br><br>
	Enter an epitaph for the grave:
	<br><br>
	<div align="center"><input dojoType=dijit.form.TextBox name="epitaph" style="width: 400px"></div>
	<br><br>
	Graves in the wilderness will eventually disappear.<br>Those in a town will remain permanently in the Cemetery.    
	<br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button> 
		<button dojoType=dijit.form.Button onclick="dijit.byId('confirm-bury').hide()">Cancel</button>
	</div>
	 
</div>

<div dojoType="dijit.Dialog" id="party-message" style="display: none" title="Message" execute="displayMessages()">
    <span id="party-message-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="town-tax" style="display: none" title="Enter Town" execute="">
	<input id="land-id" name="land_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <span id="enter-town-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button onclick="enterTownSubmit(dojo.byId('land-id').value, 'gold')">Pay Gold</button>
		<button dojoType=dijit.form.Button onclick="enterTownSubmit(dojo.byId('land-id').value, 'work')">Work</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('town-tax').hide()">Cancel</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="town-raid" style="display: none" title="Raid Town" execute="raidTown(arguments[0])">
	<input id="town-id" name="town_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <span id="raid-town-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">Yes</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('town-raid').hide()">No</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="unblock-door-diag" style="display: none" title="Unblock Door">
	<input id="door-id" name="door_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    The door to the <span id="unblock-door-direction"></span> appears to be blocked.
	<br><br> 
	Do you want to charge it down, pick the lock, break any magical seals or ignore it?
	<br><br>
	Character to attempt action:
    <select id="character-id">
    	[% FOREACH character IN party.characters %]
    		[% UNLESS character.is_dead %]
				<option value="[% character.id %]">[% character.name %]</option>
			[% END %]
		[% END %]
    </select>
	<br><br>
	<div align="center">
		<button dojoType=dijit.form.Button onclick="unblockDoor('charge')">Charge Down</button>
		<button dojoType=dijit.form.Button onclick="unblockDoor('pick')">Pick Lock</button>
    	<button dojoType=dijit.form.Button onclick="unblockDoor('break')">Break Seals</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('unblock-door-diag').hide()">Ignore</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="chest-trap" style="display: none" title="Trap Detected" execute="disarmTrap(arguments[0]);">
    You detect a trap on this chest. Do you want to attempt to disarm it, or leave the chest alone?
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">Disarm Trap</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('chest-trap').hide()">Ignore Chest</button>
	</div>
</div>


<div style="position: relative">
[% INCLUDE layout/left_hand_nav.html called_from_panel=called_from_panel %]
</div>

<div class="line-sep"></div>

<div id="party_status-pane" dojoType="dijit.layout.ContentPane" style="margin-top: 2px; clear: left; font-size: 8pt; overflow: hidden"></div>

<div id="loader-gif" style="display: none">
	<img src="[% c.config.static_path %]/images/layout/loader.gif">
</div>

<div id="main-outer" style="position: relative;">
	<div id="main-loading" style="position: absolute; height: 24px; width: 24px; top: 48%; left: 48%">
		<img src="[% base %]static/images/layout/loader.gif">
	</div> 

	<div id="screen-outer"
		style="border: 1px solid #4d4d4d; min-height: 95%; min-width: 95%; max-height: 95%; background: black; 
			z-index: 600; top: 10px; position: absolute; display: none; overflow: auto">	

		<div style="float: right; margin-right: 25px">
		<div id="screen-close" style="position: fixed; padding: 2px">
			<a href="#" onclick="closeScreen()"><span class="close-icon"></span></a>
		</div>
		</div>
		
		<div id="screen-pane" dojoType="dojox.layout.ContentPane"></div>
	
	</div>

	<div id="main-middle-section" style="height: 600px; min-height: 600px; text-align: center;">
	
		<div id="map-outer" style="position: relative; visibility: hidden; display: inline-block">
			<div dojoType="dijit.layout.ContentPane" title="Map" id="map-pane"></div>
			
			<div dojoType="dijit.layout.ContentPane" id="messages-pane" 
				style="padding: 5px; position: absolute; bottom: 10px; left: 10px; opacity:0.8; background: black; z-index: 500; text-align: left;
				       border: 1px solid #4d4d4d; visibility: hidden;">
			</div>
			
			<div dojoType="dijit.layout.ContentPane" id="creatures-pane" style="position: absolute; top: 2px; left: 2px; background: black; 
				z-index: 400;"></div>
				
			<div dojoType="dijit.layout.ContentPane" id="mini_map-pane" style="position: absolute; top: 2px; right: 2px; z-index: 400; background: black;
				overflow: hidden; border: 1px solid #4d4d4d;"></div>				
		</div>		
	
		<div dojoType="dojox.layout.ContentPane" id="party-pane" 
			style="width: 300px; height: 100%; padding-left: 10px; display: inline-block; text-align: left; vertical-align: top" class="content-background"></div>	
		
	</div>
</div>

	
<div dojoType="dijit.layout.ContentPane" selected="true" title="Zoom" id="zoom-pane" region="left" style="width: 10px; display: none"></div>

<div id="popup-messages-pane" style="display: none" dojoType="dijit.layout.ContentPane"></div>



[% INCLUDE bottom.html %]
