[% INCLUDE top.html %]

<script>
dojo.require('dijit.layout.BorderContainer');
dojo.require('dijit.form.FilteringSelect');
dojo.require("dijit.form.Textarea");

function getPanels(url) {
	//console.profile();
	    
	var originalContent = dojo.byId('messages-pane').innerHTML;
	
	dijit.byId('messages-pane').setContent('Loading...');	
    
    var no_cache = "&no_cache=" + Math.random() *100000000000;
    
    if (url.indexOf('?') == -1) {
    	no_cache = '?' + no_cache;
    }
    
	dojo.xhrGet( {
        url: "[% base %]" + url + no_cache,
        handleAs: "json",
        
        load: function(responseObject, ioArgs){
			if (responseObject.error) {
				dojo.byId('error-message').innerHTML = responseObject.error;
	    		dijit.byId('error').show();
	    		dijit.byId('messages-pane').setContent(originalContent);
			}
			
			refreshPanels(responseObject);
			
			displayPopupMessages();	
			
			if (responseObject.displayDialog) {
	    		dijit.byId(responseObject.displayDialog).show();
			}
			
			if (responseObject.panel_callbacks) {
				executeCallbacks(responseObject.panel_callbacks);
			}
		},
        
        error: function(err) {
        	errorMsg = "An error occurred processing the action. Please <a href=\"[% base %]\">try again</a> or report a bug.";
        	console.debug(err);
        	dijit.byId('messages-pane').setContent(errorMsg);
        },

	    timeout: 15000 // Time in milliseconds	
    });
	
	//console.profileEnd();
}

function refreshPanels(panelData) {    
	if (panelData.panel_messages) {
		displayMessages(panelData.panel_messages);
	}				
				
    if (panelData.refresh_panels) {
		for (var panel in panelData.refresh_panels) {
			dijit.byId(panel+'-pane').setContent(panelData.refresh_panels[panel]);
			dijit.byId(panel+'-pane').refresh();
			//dijit.byId(panel+'-pane').parseOnLoad = true;
		}
	}	
}

function setPanel(panel, url) {
	dijit.byId(panel+'-pane').href = url;
	dijit.byId(panel+'-pane').refresh();
}

function displayPopupMessages() {
	if (dojo.trim(dojo.byId('popup-messages-pane').innerHTML)) {
		show_message(dojo.byId('popup-messages-pane').innerHTML);
		dojo.byId('popup-messages-pane').innerHTML = '';
	}
}

[%# TODO: maybe better with a closure, rather than globals? %]
var panel_messages;
var displayCount = 0;	
function displayMessages(messages_passed) {
	if (messages_passed) {
		panel_messages = messages_passed;
	}
	
	if (! panel_messages) {
		return;
	}
	
	if (panel_messages[displayCount]) {
		dojo.byId('party-message-text').innerHTML = panel_messages[displayCount];
		dijit.byId('party-message').show();
		displayCount++;
	}
	else {
		displayCount = 0;
	}
}

function executeCallbacks(callBacks) {
	for (var callIdx in callBacks) {
		callback = callBacks[callIdx];
		
		var callbackName = callback.name + "Callback"
		window[callbackName](callback.data);		
	}
}

function dungeonCallback(data) {
	var updatedSectors = data.sectors;
	for (var x in updatedSectors) {
		for (var y in updatedSectors[x]) {
			if (updatedSectors[x][y]) {
				sector = updatedSectors[x][y];
			
				var sector_id = "sector_" + x + "_" + y;
			
				if (! dojo.byId(sector_id)) {
					// Create sector
					newSector = document.createElement("div");
					newSector.setAttribute('id', sector_id);
					newSector.style.position = 'absolute';					
					newSector.style.top = (y - data.boundaries.min_y) * 40;
					newSector.style.left = (x - data.boundaries.min_x) * 40; 
					newSector.style.width = '40px';
					newSector.style.height = '40px';
					dojo.byId('dungeon_outer').appendChild(newSector); 
				}

				dojo.byId(sector_id).innerHTML = sector.sector;
				
				
				[%# Create CG descs %]
				if (dijit.byId('cgtt_' + x + '_' + y)) {
					[%# Destroy if it used to exist %]
					dijit.byId('cgtt_' + x + '_' + y).destroyRecursive();
				}					
				if (sector.cg_desc) {
					params = {
						connectId: [sector_id],
						label: sector.cg_desc,
						id: 'cgtt_'+ x + '_' + y,
					};		
					new dijit.Tooltip(params);
				}
				
				if (dijit.byId('ptt_' + x + '_' + y)) {
					[%# Destroy if it used to exist %]
					dijit.byId('ptt_' + x + '_' + y).destroyRecursive();
				}					
				if (sector.party_desc) {
					params = {
						connectId: [sector_id],
						label: sector.party_desc,
						id: 'ptt_' + x + '_' + y,
					};		
					new dijit.Tooltip(params);				
				}		
			}		 
		}	
	}
	
	dungeonScroll(data.scroll_to); 
}

function dungeonRefreshCallback(scroll_to) {
	dungeonScroll(scroll_to); 
}

var panel_init = [% panels %];

function init() {
	refreshPanels(panel_init);
	
	scrollTo = dojo.byId('scroll_to');

	if (scrollTo) {
		console.log("Scrolling to " + scrollTo.innerHTML);
		dijit.scrollIntoView(scrollTo.innerHTML);
	}
}

function dungeonScroll(scroll_to) {
	scroll_to_sector = 'sector_' + scroll_to.x + "_" + scroll_to.y;
	loc = dojo.byId(scroll_to_sector);
	if (loc) {
		console.log("Scrolling to " + scroll_to_sector);
		dijit.scrollIntoView(loc);
	}
}


function selectActionCombat(action, char_id, action_param, action_param2, action_label){
	if (! action_label) {
		action_label = action;
	}
	
	if (! action_param) {
		action_param = '';
	}

	dijit.byId('char_action_button_' + char_id).setLabel(action_label);
		
	var url = "/party/select_action?action=" + action + "&character_id=" + char_id + "&action_param=" + (action_param || '') +
		        "&action_param=" + (action_param2 || '')
	
	dojo.xhrGet( {
        url: "[% base %]" + url,
        handleAs: "json",        

	    timeout: 15000 // Time in milliseconds	
    });
}

function selectActionNonCombat(action, char_id, action_param, action_param2, action_label){
	if (! action_label) {
		action_label = action;
	}
	
	if (! action_param) {
		action_param = '';
	}

	dijit.byId('char_action_button_' + char_id).setLabel(action_label);

	getPanels("/party/select_action?action=" + action + "&character_id=" + char_id + "&action_param=" + (action_param || '') +
		        "&action_param=" + (action_param2 || ''));
	        
	return false;
}

dojo.require("dojo.dnd.Source");
dojo.require("dijit.Menu");
dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
	var t = dojo.dnd.manager().target;

	order_val = t.current.id.split(/-/);
	var char_2 = order_val[1];

	var drop_pos;
	(t.before == true) ? drop_pos='before' : drop_pos='after';
	
	if (nodes[0].id == 'rank_separator') {
    	dojo.xhrGet( {
	        url: "[% base %]/party/move_rank_separator?target=" + char_2 + "&drop_pos=" + drop_pos, 
	        handleAs: "text",

    	    timeout: 5000 // Time in milliseconds	
        });			
	}
	else {
    	order_val = nodes[0].id.split(/-/);
		var char_1 = order_val[1];
		
    	dojo.xhrGet( {
	        url: "[% base %]/party/swap_chars?moved=" + char_1 + "&target=" + char_2 + "&drop_pos=" + drop_pos, 
	        handleAs: "text",

    	    timeout: 5000 // Time in milliseconds	
        });
    }
});

dojo.addOnLoad( init );

/* From healer panel */
function healParty(dialogFields) {
	getPanels('/town/heal_party?gold=' + dialogFields.heal_amount);
}

function findTown(dialogFields) {
	getPanels("/town/sage/find_town?town_name=" + dialogFields.town_name + "&find_type=" + dialogFields.find_type);
}

function findItem(dialogFields) {
	getPanels("/town/sage/find_item?item_type_to_find=" + dialogFields.item_type_to_find);
}

function findDungeon(dialogFields) {
	getPanels("/town/sage/find_dungeon?find_level=" + dialogFields.find_level);
}

function disarmTrap(dialogFields) {
	getPanels("/dungeon/disarm_trap");
}

function checkAttack(creatureGroupId, confirmAttack, in_dungeon) {
	if (confirmAttack == 1) {
		dojo.byId('creature-group-id').value = creatureGroupId;
		dijit.byId('confirm-attack').show();
	}
	else {
		prefix = '';
		if (in_dungeon) {
			prefix = '/dungeon';
		}
		
		getPanels(prefix + '/combat/party_attacks?creature_group_id=' + creatureGroupId);
	}
}

function execConfirmedAttack(dialogFields) {
	getPanels('/combat/party_attacks?creature_group_id=' + dialogFields.creature_group_id);
}

function buryDiag(char_name, char_id) {
	dojo.byId('bury-message').innerHTML = "Are you sure you want to bury " + char_name + "?";
	dojo.byId('char-id').value = char_id;
	dijit.byId('confirm-bury').show();
}

function bury(dialogFields) {
	getPanels('/character/bury?character_id=' + dialogFields.char_id + '&epitaph=' + dialogFields.epitaph);
}

function enterTown(land_id, gold_cost, turn_cost) {
	dojo.byId('enter-town-text').innerHTML = "You must pay the daily tax to enter this town.<br><br>You can either pay " + gold_cost 
		+ " gold, or work for the town for " + turn_cost + " turns.";
	dojo.byId('land-id').value = land_id;
	dijit.byId('town-tax').show();
}

function enterTownSubmit(land_id, paymentMethod){
	getPanels('/town/enter?land_id=' + land_id + "&payment_method=" + paymentMethod);
	dijit.byId('town-tax').hide();
}

function confirmRaidTown(town_name, town_id) {
	dojo.byId('raid-town-text').innerHTML = "Are you sure you want to raid " + town_name + "?";
	dojo.byId('town-id').value = town_id;
	dijit.byId('town-raid').show();	
}

function raidTown(dialogFields){
	getPanels('/town/raid?town_id=' + dialogFields.town_id);
}

function unblockDoorDiag(direction, door_id) {
	dojo.byId('unblock-door-direction').innerHTML = direction;
	dojo.byId('door-id').value = door_id;
	dijit.byId('unblock-door-diag').show();
}

function unblockDoor(action) {
	dijit.byId('unblock-door-diag').hide();
	getPanels('/dungeon/unblock_door?door_id=' + dojo.byId('door-id').value + '&character_id=' + dojo.byId('character-id').value + '&action=' + action);
}

</script>

<div dojoType="dijit.Dialog" id="confirm-attack" style="display: none" title="Confirm Attack" execute="execConfirmedAttack(arguments[0]);">
    <span id="confirmation-message">Are you sure you want to attack these creatures? They look pretty tough!</span>
    <input id="creature-group-id" name="creature_group_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	<br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button> 
		<button dojoType=dijit.form.Button onclick="dijit.byId('confirm-attack').hide()">Cancel</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="confirm-bury" style="display: none" title="Bury Character" execute="bury(arguments[0]);">
    <input id="char-id" name="char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	<span id="bury-message"></span>
	<br><br>
	Enter an epitaph for the grave:
	<br><br>
	<div align="center"><input dojoType=dijit.form.TextBox name="epitaph" style="width: 400px"></div>
	<br><br>
	Graves in the wilderness will eventually disappear.<br>Those in a town will remain permanently in the Cemetery.    
	<br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button> 
		<button dojoType=dijit.form.Button onclick="dijit.byId('confirm-bury').hide()">Cancel</button>
	</div>
	 
</div>

<div dojoType="dijit.Dialog" id="party-message" style="display: none" title="Message" execute="displayMessages()">
    <span id="party-message-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">OK</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="town-tax" style="display: none" title="Enter Town" execute="">
	<input id="land-id" name="land_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <span id="enter-town-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button onclick="enterTownSubmit(dojo.byId('land-id').value, 'gold')">Pay Gold</button>
		<button dojoType=dijit.form.Button onclick="enterTownSubmit(dojo.byId('land-id').value, 'work')">Work</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('town-tax').hide()">Cancel</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="town-raid" style="display: none" title="Raid Town" execute="raidTown(arguments[0])">
	<input id="town-id" name="town_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <span id="raid-town-text"></span>
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">Yes</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('town-raid').hide()">No</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="unblock-door-diag" style="display: none" title="Unblock Door">
	<input id="door-id" name="door_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    The door to the <span id="unblock-door-direction"></span> appears to be blocked.
	<br><br> 
	Do you want to charge it down, pick the lock, break any magical seals or ignore it?
	<br><br>
	Character to attempt action:
    <select id="character-id">
    	[% FOREACH character IN party.characters %]
			<option value="[% character.id %]">[% character.name %]</option>
		[% END %]
    </select>
	<br><br>
	<div align="center">
		<button dojoType=dijit.form.Button onclick="unblockDoor('charge')">Charge Down</button>
		<button dojoType=dijit.form.Button onclick="unblockDoor('pick')">Pick Lock</button>
    	<button dojoType=dijit.form.Button onclick="unblockDoor('break')">Break Seals</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('unblock-door-diag').hide()">Ignore</button>
	</div>
</div>

<div dojoType="dijit.Dialog" id="chest-trap" style="display: none" title="Trap Detected" execute="disarmTrap(arguments[0]);">
    You detect a trap on this chest. Do you want to atttempt to disarm it, or leave the chest alone?
    <br>
	<div align="center">
    	<button dojoType=dijit.form.Button type="submit">Disarm Trap</button>
		<button dojoType=dijit.form.Button onClick="dijit.byId('chest-trap').hide()">Ignore Chest</button>
	</div>
</div>

<h2>[% party.name %]</h2>

<div id="party_status-pane" dojoType="dijit.layout.ContentPane">
[% INCLUDE party/status.html %]
</div>

<div dojoType="dijit.layout.ContentPane" id="dungeon-pane" style="display: none"></div>

<div dojoType="dijit.layout.BorderContainer"
				design="sidebar"                
                style="border: 1px solid #bfbfbf; width: 98%; height: 380px; margin:0px auto;"
				class="content-background">

	<div dojoType="dijit.layout.ContentPane" selected="true" title="Map" region="left" style="width: 430px; height: 350px;">
		
			<div dojoType="dijit.layout.BorderContainer"
				design="sidebar" gutter=false
                style="width: 420px; margin:0px auto; padding: 0px">
					<div dojoType="dijit.layout.ContentPane" selected="true" title="Zoom" id="zoom-pane" region="left" style="width: 10px;">					
					</div>

					<div dojoType="dijit.layout.ContentPane" selected="true" title="Map" id="map-pane" region="center" style="width: 400px; background: #898E73;">					
				</div>
			</div>
	</div>

	<div dojoType="dijit.layout.ContentPane" selected="true" title="Messages" id="messages-pane" region="center" 
		style="padding-left: 5px;" class="content-background">

	</div>
</div>

<br><br>

<div dojoType="dojox.layout.ContentPane" id="party-pane" style="overflow: visible;" class="content-background">

</div>

<div id="popup-messages-pane" style="display: none" dojoType="dijit.layout.ContentPane">
	
</div>



[% INCLUDE bottom.html %]