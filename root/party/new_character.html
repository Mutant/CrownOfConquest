[% INCLUDE top.html %]

<h1>New Character</h1>


<div style="visibility: hidden; position: absolute; top: 0px; z-index: -100" id="points-div"></div>

<style>
#stats-set {
	display: block;
	float: left;
}

.stat {
	width: 70px;
}

.stat-header {
	width: 70px;
	min-width: 70px;
}
</style>

<script>
var points = Object();
function calcPoints() {
	dojo.xhrGet( {
        url: "[% base %]/party/create/calculate_values",
        handleAs: "json",
        load: function(responseObject, ioArgs) {
            document.form.hit_points.value = responseObject.hit_points || '';
		    document.form.magic_points.value = responseObject.magic_points || '';
	    	document.form.faith_points.value = responseObject.faith_points || '';    
    	},
        form: "form",
    });
}

var raceStats = new Object;
[% FOREACH race = races %]
	var base = new Object;
	base.str = '[% race.base_str %]';
	base.int = '[% race.base_int %]';
	base.div = '[% race.base_div %]';
	base.con = '[% race.base_con %]';
	base.agl = '[% race.base_agl %]';

	raceStats['[% race.race_id %]'] = base;
[% END %]

var Stats = Array('str','int','div','con','agl');

//dojo.addOnLoad( setBaseStats(document.getElementById('race-sel')) );

function setBaseStats(raceSel) {
	if (raceSel.value) {
		document.form.base_str.value = raceStats[raceSel.value].str;
		document.form.base_int.value = raceStats[raceSel.value].int;
		document.form.base_div.value = raceStats[raceSel.value].div;
		document.form.base_con.value = raceStats[raceSel.value].con;
		document.form.base_agl.value = raceStats[raceSel.value].agl;
	}
	else {
		document.form.base_str.value = null;
		document.form.base_int.value = null;
		document.form.base_div.value = null;
		document.form.base_con.value = null;
		document.form.base_agl.value = null;
	}

	for (var i=0; i<Stats.length; i++) {
		calculateTotal(Stats[i]);
	}
	
	calcPoints();
}

function calculateTotal(stat) {
	input = Number(String(document.getElementsByName('mod_' + stat)[0].value));

	base  = document.getElementsByName('base_' + stat)[0];
    total = document.getElementsByName('total_disp_' + stat)[0];
    total.value = input + Number(String(base.value));

	if (total.value == 'NaN') {
		total.value = base.value;
	}
	
	console.log(stat);
	console.log(dojo.byId('total_' + stat));
	dojo.byId('total_' + stat).value = total.value;
	console.log(total.value);
	console.log(dojo.byId('total_' + stat).value);

	var pool = [% stats_pool %];
	for (var i=0; i<Stats.length; i++) {
		stats_mod = Number(String(document.getElementsByName('mod_' + Stats[i])[0].value));
		pool -= stats_mod;
	}
	document.getElementsByName('remaining')[0].value = pool;	
}
</script>

<form name="form" method="post" id="form" action="[% base %]/party/create/create_character">

<fieldset id="basic">
<legend>Basic Information</legend>
<label for="character_name">Character Name:</label>
<input type="text" size="50" name="name" id="character_name"><br>

<label for="race">Race:</label>
<select name="race" id="race-sel" onChange="setBaseStats(this)">
	<option></option>
[% FOREACH race = races %]
	<option value="[% race.id %]">[% race.race_name %]</option>
[% END %]
</select><br>

<label for="class">Class:</label>
<select name="class" onChange="calcPoints()">
	<option></option>
[% FOREACH class = classes %]
	<option value="[% class.class_name %]">[% class.class_name %]</option>
[% END %]
</select><br>
</fieldset>

<fieldset id="stats-set">
<legend>Stats</legend>

<label></label>
<span class="stat-header">Base</span>
<span class="stat-header">Modifier</span>
<span class="stat-header">Total</span><br>
	
<label for="stength">Strength:</label>
<input type="text" size="3" name="base_str"  class="stat" disabled="disabled">
<input type="text" size="3" name="mod_str"   class="stat" onkeyup="calculateTotal('str')" onChange="calcPoints()">
<input type="text" size="3" name="total_disp_str" class="stat" disabled="disabled"><br>
<input type="hidden" name="total_str" id="total_str">

<label for="stength">Agility:</label>
<input type="text" size="3" name="base_agl"  class="stat" disabled="disabled">
<input type="text" size="3" name="mod_agl"   class="stat" onkeyup="calculateTotal('agl')" onChange="calcPoints()">
<input type="text" size="3" name="total_disp_agl" class="stat" disabled="disabled"><br>
<input type="hidden" name="total_agl" id="total_agl">

<label for="stength">Intelligence:</label>
<input type="text" size="3" name="base_int"  class="stat" disabled="disabled">
<input type="text" size="3" name="mod_int"   class="stat" onkeyup="calculateTotal('int')" onChange="calcPoints()">
<input type="text" size="3" name="total_disp_int" class="stat" disabled="disabled"><br>
<input type="hidden" name="total_int" id="total_int">

<label for="stength">Divinity:</label>
<input type="text" size="3" name="base_div"  class="stat" disabled="disabled">
<input type="text" size="3" name="mod_div"   class="stat" onkeyup="calculateTotal('div')" onChange="calcPoints()">
<input type="text" size="3" name="total_disp_div" class="stat" disabled="disabled"><br>
<input type="hidden" name="total_div" id="total_div">

<label for="stength">Constitution:</label>
<input type="text" size="3" name="base_con"  class="stat" disabled="disabled">
<input type="text" size="3" name="mod_con"   class="stat" onkeyup="calculateTotal('con')" onChange="calcPoints()">
<input type="text" size="3" name="total_disp_con" class="stat" disabled="disabled"><br>
<input type="hidden" name="total_con" id="total_con">
<br>
<label for="remaining">Points Remaining:</label>
<input type="text" size="3" name="remaining" disabled="disabled" class="stat" value="[% stat_pool %]">
</fieldset>
<br>
<label for="remaining">Hit Points:</label>
<input type="text" size="3" name="hit_points" disabled="disabled" class="stat">
<br>
<label for="remaining">Magic Points:</label>
<input type="text" size="3" name="magic_points" disabled="disabled" class="stat">
<br>
<label for="remaining">Faith Points:</label>
<input type="text" size="3" name="faith_points" disabled="disabled" class="stat">
<br>
<input type="submit" value="Create Character">
</form>
[% INCLUDE bottom.html %]
