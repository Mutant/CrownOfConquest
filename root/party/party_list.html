<h3>Party Members</h3>

<table [% UNLESS party.in_combat_with %]dojoType="dojo.dnd.Source"[% END %] id="party-table" accept="character" moveOnly="true" class="main">
<tr>
	<th></th>
    <th>Name</th>
    <th>Race</th>
    <th>Class</th>
    <th>Level</th>
    <th>HP</th>
    <th>XP</th>
    <th>Effects</th>

</tr>

[% FOREACH char IN characters %]
[% char_id = char.id %]
<tr 
	[% UNLESS party.in_combat_with %]class="dojoDndItem"[% END %] 
	dndType="character" 
	accept="character"
	id="char-[% char.id %]" 
	jsId="char-[% char.id %]" 
	[% IF char.is_dead %]style="background: #D3D3D3"[% END %]
>
	<td nowrap="nowrap">
		[% IF char.stat_points %]
			<span id="statPoint-[% char.character_id %]"><a href="[% base %]/character/view?character_id=[% char.character_id %]">[+]</a></span>
			<div dojoType="dijit.Tooltip"
                   connectId="statPoint-[% char.character_id %]"
                   label="[% char.stat_points %] stat points to be assinged">
            </div>
			</span>
		[% END %]
		[% IF broken_items.${char.id} %]
			<span id="brokenItems-[% char.character_id %]">[!]</span>
			<div dojoType="dijit.Tooltip"
                   connectId="brokenItems-[% char.character_id %]"
                   label="These equipped items need to be repaired: [% FOREACH item IN broken_items.${char.id} %][% item.display_name %][% UNLESS loop.last %], [% END %][% END %]">
            </div>
			</span>
		[% END %]
	</td>
    <td nowrap="nowrap"><a href="[% base %]/character/view?character_id=[% char.character_id %]">[% char.character_name %]</a></td>
    <td nowrap="nowrap">[% char.race.race_name %]</td>
    <td nowrap="nowrap">[% char.class.class_name %]</td>
    <td nowrap="nowrap" align="center">[% char.level %]</td>
    <td nowrap="nowrap">[% IF char.is_dead %]Dead[% ELSE %][% char.hit_points %] / [% char.max_hit_points %][% END %]</td>
    <td nowrap="nowrap">[% char.xp %]</td>
    <td nowrap="nowrap">[% FOREACH effect IN char.character_effects %][% effect.effect.effect_name %][% UNLESS loop.last() %],[% END %][% END %]</td>
    
	<td align="center">
    [% UNLESS char.is_dead %]    
        <div dojoType="dijit.form.DropDownButton" id="char_action_button_[% char.id %]">
        	 [% IF party.in_combat_with %]
        	 	[% label = char.last_combat_action %]
        	 [% ELSE %]
        	 	[% label = "Action" %]
        	 [% END %]

             <span>[% label %]</span>
    	     <div dojoType="dijit.Menu" style="display: none">


			[% IF party.in_combat_with %]
		         <div dojoType="dijit.MenuItem" onClick="selectAction('Attack', '[% char.id %]');">Attack</div>
		         <div dojoType="dijit.MenuItem" onClick="selectAction('Defend', '[% char.id %]');">Defend</div>	        
	             <div dojoType="dijit.PopupMenuItem">
		             <span>Target</span>
		              <div dojoType="dijit.Menu">
						 [% FOREACH creature IN creatures %]
						 	[% UNLESS creature.is_dead %]
				            <div dojoType="dijit.MenuItem" onClick="selectAction('Attack', '[% char.id %]', '[% creature.id %]', '', 'Targetting: [% creature.name %]')">[% creature.name %]</div>
				            [% END %]
				         [% END %]
				    </div>
		        </div>
		    [% END %]
		        
		        [% IF spells.$char_id %]
		        [% character_spells = spells.$char_id %]
	             <div dojoType="dijit.PopupMenuItem">
		             <span>Cast</span>
		             <div dojoType="dijit.Menu">
						 [% FOREACH memorised_spell IN character_spells %]
						    [% spell = memorised_spell.spell %]
						 	[% IF spell.target == 'character' || spell.target == 'creature' %]
						    	<div dojoType="dijit.PopupMenuItem">
  					             <span>[% spell.spell_name %] ([% memorised_spell.casts_left_today %])</span>
					             <div dojoType="dijit.Menu">
  					             [% IF spell.target == 'creature' %]
									 [% FOREACH creature IN creatures %]
									 	[% UNLESS creature.is_dead %]
							            <div dojoType="dijit.MenuItem" 
							            	onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '[% creature.id %]', 
							            		'Casting [% spell.spell_name %] on: [% creature.name %]')">[% creature.name %]</div>
							            [% END %]
							         [% END %]
								 [% ELSE %]
    								 [% FOREACH character IN characters %]
									 	[% UNLESS character.is_dead %]
							            <div dojoType="dijit.MenuItem" 
							            	onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '[% character.id %]', 
							            		'Casting [% spell.spell_name %] on: [% character.name %]')">[% character.name %]</div>
							            [% END %]
							         [% END %]
								 [% END %]
						 	     </div>
						 	     </div>
  					             
						 	[% ELSE %]
				            <div dojoType="dijit.MenuItem" onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '', 
							            		'Casting [% spell.spell_name %]">[% spell.spell_name %]</div>
				            [% END %]
			             [% END %]
		            </div>
		        </div>
		        [% END %]

            </div>            
            
        </div>
	[% ELSE %]
		[% UNLESS party.in_combat_with %]
			<button dojoType="dijit.form.Button" onclick="buryDiag('[% char.character_name %]', '[% char.character_id %]')">Bury</button>
		[% END %]
    [% END %]
	</td>
    
    [% IF party.rank_separator_position == char.party_order %]
    	</tr>
    	<tr>
    		<tr [% UNLESS party.in_combat_with %]class="dojoDndItem"[% END %] dndType="separator" id="rank_separator" jsId="rank_separator">
    			<td colspan="10"></td>
    [% END %]
</tr>
[% END %]
</table>