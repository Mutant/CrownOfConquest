[% USE infl = Lingua.EN.Inflect; %]

<div style=""> 

[% MACRO spell_target_list(caster, spell, casts_left_today, targets) BLOCK %]
	var spellSubMenu = new dijit.Menu({id:"spellMenu_[% memorised_spell.id %]"});						
	[% FOREACH target IN targets %]
		[% UNLESS target.is_dead %]
			params = {
				label: "[% target.name %]",
				onClick: function() {
					[% action_function %]('Cast','[% caster.id %]', '[% spell.id %]', '[% target.id %]','Casting [% spell.spell_name %] on: [% target.name | replace("'","\\'") %]');
				}
			};
			
			var item = new dijit.MenuItem(params,document.createElement("div"));
			spellSubMenu.addChild(item);			
		[% END %]
	[% END %]
	
	if (dijit.byId("spellPopupMenu_[% caster.id %]_[% spell.id %]")) {
		dijit.byId("spellPopupMenu_[% caster.id %]_[% spell.id %]").destroyRecursive();
	}
	
	var spellPopupMenu = new dijit.PopupMenuItem(
		{
			label: "[% spell.spell_name %] ([% casts_left_today %])", 
			popup:spellSubMenu, 
			id:"spellPopupMenu_[% caster.id %]_[% spell.id %]",
			iconClass: "menuExpandIcon"
		}
	);		
	
	castSubMenu.addChild(spellPopupMenu); 	

[% END %]

<script>
	function createMenus() {
		[% FOREACH char IN characters %]
			[% NEXT IF character.is_dead %]
			[% char_id = char.id %]
			if (dijit.byId('char_action_button_[% char_id %]') != undefined) {
				dijit.byId('char_action_button_[% char_id %]').destroyRecursive();			
			}
			
			if (dijit.byId('actionMenu_[% char_id %]') ) {
				dijit.byId('actionMenu_[% char_id %]').destroyRecursive();
			}
			
			[% action_function = 'selectActionNonCombat' %]
			[% IF in_combat %]
				[% action_function = 'selectActionCombat' %]
			[% END %]

			var params = {id:"actionMenu_[% char_id %]"};
			var menu = new dijit.Menu(params,document.createElement("div"));
			
			[% IF in_combat %]
				params = {
					label: "Attack",
					onClick: function() {
						[% action_function %]('Attack','[% char.id %]');
					}
				};			
				var attackItem = new dijit.MenuItem(params,document.createElement("div"));
				menu.addChild(attackItem);			
	
				params = {
					label: "Defend",
					onClick: function() {
						[% action_function %]('Defend','[% char.id %]');
					}
				};			
				var defendItem = new dijit.MenuItem(params,document.createElement("div"));
				menu.addChild(defendItem);	
				
				var targetSubMenu = new dijit.Menu({label: "Target"}); 
			
				[% FOREACH opponent IN opponents %]
					[% UNLESS opponent.is_dead %]
						params = {
							label: "[% opponent.name %]",
							onClick: function() {
								[% action_function %]('Attack','[% char.id %]', '', '[% opponent.id %]','Targetting: [% opponent.name | replace("'","\\'") %]');
							}
						};
						
						var item = new dijit.MenuItem(params,document.createElement("div"));
						targetSubMenu.addChild(item);
						
					[% END %]
				[% END %]	
				
				params = {
					label: "Target",
					popup:targetSubMenu,
					iconClass: "menuExpandIcon"
				};			
				var targetPopupMenu = new dijit.PopupMenuItem(params);
				menu.addChild(targetPopupMenu);
				
			[% END %]  

			[% character_spells = spells.$char_id %]
			
			[% IF character_spells %]
				var castSubMenu = new dijit.Menu();
			
				[% FOREACH memorised_spell IN character_spells %]
					[% spell = memorised_spell.spell %]
					if (dijit.byId("spellMenu_[% memorised_spell.id %]")) {
						dijit.byId("spellMenu_[% memorised_spell.id %]").destroyRecursive();
					}
					
					[% IF spell.target == 'creature' || spell.target == 'character' %]
						[% targets = spell.target == 'creature' ? opponents : characters %]
						[% spell_target_list(char, spell, memorised_spell.casts_left_today, targets) %]
					[% END %]
					
					[% IF spell.target == 'party' %]
						params = {
							label: "[% spell.spell_name %] ([% memorised_spell.casts_left_today %])",
							onClick: function(){
								[% action_function %]('Cast', '[% char.id %]', '[% spell.id %]', '[% party.id %]', 'Casting [% spell.spell_name %]')
							}
						};
						var item = new dijit.MenuItem(params,document.createElement("div"));
						
						castSubMenu.addChild(item);
					[% END %]							
				[% END %]
				
				params = {
					label: "Cast",
					popup:castSubMenu,
					iconClass: "menuExpandIcon"
				};			
				var castPopupMenu = new dijit.PopupMenuItem(params);
				menu.addChild(castPopupMenu);				
			[% END %]

		[% IF in_combat %]
        	[% label = char.last_combat_action %]
		[% ELSE %]
         	[% label = "Action" %]
		[% END %]
		
		var dropDown = new dijit.form.DropDownButton({id: 'char_action_button_[% char_id %]', label: '[% label %]'}, dojo.byId('char_action_holder_[% char_id %]'));
		dropDown.dropDown = menu;
		
		[% END %]
	}
	dojo.addOnLoad( createMenus );
</script>

<table [% UNLESS in_combat %]dojoType="dojo.dnd.Source"[% END %] 
	id="party-table" accept="character" moveOnly="true" class="main" align="center" cellspacing=0 cellpadding=2>

	<tr>
		<td colspan="8">
		[% IF party.party_effects %]
		Party Effects: 
			[% FOREACH effect IN party.party_effects %]
				[% effect.effect.effect_name %] ([% FILTER inflect %]NO([% effect.effect.time_type %], [% effect.effect.time_left %])[% END %] left )
				[% UNLESS loop.last %],[% END %]
			[% END %]
		<br>
		[% END %] 
		<br>
		</td>
	</tr>
		
	
<tr>
	<td colspan="8">
		<h3>Party Members</h3>
	</td>
</tr>
<tr>
	<th></th>
    <th>Name</th>
    <th>Race</th>
    <th>Class</th>
    <th>Level</th>
    <th>HP</th>
	<th></th>
    <th>XP</th>
    <th>Effects</th>

</tr>

[% FOREACH char IN characters %]
[% char_id = char.id %]

<tr 
	[% UNLESS in_combat %]class="dojoDndItem"[% END %] 
	dndType="character" 
	accept="character"
	id="char-[% char.id %]" 
	jsId="char-[% char.id %]" 
	[% IF char.is_dead %]style="background: #D3D3D3"[% END %]
>
	<td nowrap="nowrap">
		[% IF char.stat_points %]
			<span id="statPoint-[% char.character_id %]"><a href="[% base %]/character/view?character_id=[% char.character_id %]">[+]</a></span>
			<div dojoType="dijit.Tooltip"
                   connectId="statPoint-[% char.character_id %]"
                   label="[% char.stat_points %] stat points to be assigned">
            </div>
			</span>
		[% END %]
		[% char_out_of_ammo = char.run_out_of_ammo %]
		[% IF broken_items.${char.id} || char_out_of_ammo %]
			[% label = '' %]
			[% IF broken_items.${char.id} %]
				[% label = 'These equipped items need to be repaired: ' %]
				[% FOREACH item IN broken_items.${char.id} %]
					[% label = label _ item.display_name %]
					[% UNLESS loop.last %][% label = ',' %][% END %]
				[% END %]
			[% END %]
			[% IF char_out_of_ammo %]
				[% IF label != '' %][% label = label _ '<br>' %][% END %]
				[% label = label _ char.name _ ' has run out of ammo for ' _ char.pronoun('posessive-subjective') _ ' ' _ char.weapon %]
			[% END %]
		
			<span id="brokenItems-[% char.character_id %]">[!]</span>
			<div dojoType="dijit.Tooltip"
                   connectId="brokenItems-[% char.character_id %]"
                   label="[% label %]">
            </div>
			</span>
		[% END %]
	</td>
    <td nowrap="nowrap"><a href="[% base %]/character/view?character_id=[% char.character_id %]">[% char.character_name %]</a></td>
    <td nowrap="nowrap">[% char.race.race_name %]</td>
    <td nowrap="nowrap">[% char.class.class_name %]</td>
    <td nowrap="nowrap" align="center">[% char.level %]</td>
    <td nowrap="nowrap">[% IF char.is_dead %]Dead[% ELSE %][% char.hit_points %] / [% char.max_hit_points %][% END %]</td>
	<td>&nbsp;&nbsp;</td>
    <td nowrap="nowrap">[% char.xp %]</td>
    <td nowrap="nowrap">[% FOREACH effect IN char.character_effects %][% effect.effect.effect_name %] ([% effect.effect.time_left %])[% UNLESS loop.last() %],[% END %][% END %]</td>

	<td align="center">
    [% UNLESS char.is_dead %]
		<div id="char_action_holder_[% char.id %]" class="main"></div>    
	[% ELSE %]
		[% UNLESS in_combat %]
			<button dojoType="dijit.form.Button" onclick="buryDiag('[% char.character_name | replace("'","\\'") %]', '[% char.character_id %]')">Bury</button>
		[% END %]
    [% END %]


	</td>
    [% IF party.rank_separator_position == char.party_order %]
    	</tr>
    	<tr>
    		<tr [% UNLESS in_combat %]class="dojoDndItem"[% END %] dndType="separator" id="rank_separator" jsId="rank_separator">
    			<td colspan="10"></td>
    [% END %]
</tr>
[% END %]

</table>
</div>