[% USE infl = Lingua.EN.Inflect; %]

<script>

function loadFightMenu(charId) {
	var menu = dijit.byId('fightMenu_' + charId);
	clearMenu(menu);
	dijit.byId("fightMenuLoading_" + charId).attr('style', 'display: block; padding: 0px');

	dojo.xhrGet( {
        url: "[% base %]combat/target_list",
        handleAs: "json",
        
        load: function(responseObject, ioArgs){
        	clearMenu(menu);
			
			for (var i in responseObject.opponents) {
				itemId = "fightOpponent_" + charId + "_" + responseObject.opponents[i].id;
			
				menuItem = dijit.byId(itemId);
				
				if (menuItem) {
					menuItem.attr('style', 'display: block; padding: 0px');
				}
				else {
				
					menuItem = new dijit.MenuItem({
				        label: responseObject.opponents[i].name,
				        onClick: function() { selectAction(this, 'Attack') },
				        id: itemId
				    });
				    menu.addChild(menuItem);
			    }			
			}
		},
        
	    timeout: 15000 // Time in milliseconds	
    });	
}

function loadCastMenu(charId) {
	var menu = dijit.byId('castMenu_' + charId);
	clearMenu(menu);
	dijit.byId("castMenuLoading_" + charId).attr('style', 'display: block; padding: 0px');

	dojo.xhrGet( {
        url: "[% base %]combat/spell_list?character_id=" + charId,
        handleAs: "json",
        
        load: function(responseObject, ioArgs){
        	clearMenu(menu);
			
			for (var i in responseObject.spells) {
				spellId = "castSpell_" + charId + "_" + responseObject.spells[i].id;
				menuItem = dijit.byId(spellId);
				
				if (menuItem) {
					menuItem.destroyRecursive();
				}
	
				var subMenuId = "spellSubMenu_" + charId + "_" + responseObject.spells[i].id;
				var spellSubMenu = new dijit.Menu({id: subMenuId});	
				
				var loadingItem = new dijit.MenuItem({
			        label: "Loading...",
			        id: "castSubMenuLoading_" + charId + "_" + responseObject.spells[i].id,
			    });
			    spellSubMenu.addChild(loadingItem); 								

				var popupItem = new dijit.PopupMenuItem(
					{
						label: responseObject.spells[i].spell_name + " (" + responseObject.spells[i].number_left + ")",
						popup: spellSubMenu, 
						id: spellId,
						iconClass: "menuExpandIcon"
					}
				);
											
			    menu.addChild(popupItem);
			    dojo.connect(dijit.byId(subMenuId), 'onOpen', null, loadCastSubMenu);
			}
		},
        
	    timeout: 15000 // Time in milliseconds	
    });	
}

function loadCastSubMenu(subMenuId) {
    var parts = this.id.split('_');
    var charId = parts[1];
    var spellId = parts[2];

    menu = this;
	clearMenu(menu);

	dijit.byId("castSubMenuLoading_" + charId + "_" + spellId).attr('style', 'display: block; padding: 0px');
	
	
	dojo.xhrGet( {
        url: "[% base %]combat/spell_target_list?character_id=" + charId + "&spell_id=" + spellId,
        handleAs: "json",
        
        load: function(responseObject, ioArgs){
        	clearMenu(menu);
        	
        	for (var i in responseObject.spell_targets) {
			
				targetId = "spellTarget_" + charId + "_" + spellId + "_" + responseObject.spell_targets[i].id;
			
				menuItem = dijit.byId(targetId);
				
				if (menuItem) {
					menuItem.attr('style', 'display: block; padding: 0px');
				}
				else {			
					menuItem = new dijit.MenuItem({
				        label: responseObject.spell_targets[i].name,
				        onClick: function() { selectAction(this, 'Cast') },
				        id: targetId
				    });
				    menu.addChild(menuItem);
			    }	
			}
		},
        
	    timeout: 15000 // Time in milliseconds	
    });	
}

function selectAction(menuItem, action) {
	var parts = menuItem.id.split('_');
	selectActionCombat(action, parts[1], parts[2], parts[3]);
}

var buttons = Array('attack', 'defend', 'cast', 'use'); 
function selectActionCombat(action, char_id, action_param, action_param2) {		
	var url = "/party/select_action?action=" + action + "&character_id=" + char_id + "&action_param=" + (action_param || '') +
		        "&action_param=" + (action_param2 || '')
	
	for (x in buttons) {
	    var button = buttons[x];
		var display = (button == action.toLowerCase() ? 'On' : 'Off');
		var hide = (display == 'On' ? 'Off' : 'On'); 
		
		//console.log("display: " + button + display + "_" + char_id);
		var imgDisplay = dojo.byId(button + display + "_" + char_id);
		if (imgDisplay) imgDisplay.style.display = 'inline'; 

		//console.log("hide: " + button + hide + "_" + char_id);
		var imgHide = dojo.byId(button + hide + "_" + char_id);
		if (imgHide) imgHide.style.display = 'none';
	} 
	
	dojo.xhrGet( {
        url: "[% base %]" + url,
        handleAs: "json",        

	    timeout: 15000 // Time in milliseconds	
    });
}

function selectActionNonCombat(action, char_id, action_param, action_param2, action_label){
	if (! action_label) {
		action_label = action;
	}
	
	if (! action_param) {
		action_param = '';
	}

	dijit.byId('char_action_button_' + char_id).setLabel(action_label);

	getPanels("/party/select_action?action=" + action + "&character_id=" + char_id + "&action_param=" + (action_param || '') +
		        "&action_param=" + (action_param2 || ''));
	        
	return false;
}

function clearMenu(menu) {
	var children = menu.getChildren();
	for (var i in children) {				
		children[i].attr('style','display: none');
	}
}

function createMenus() {
	if (dijit.byId('action_menu') != undefined) {
		dijit.byId('action_menu').destroyRecursive();			
	}
	

   [% FOREACH character IN characters %]    
	var params = {id:"fightMenu_[% character.id %]" };

	var menu = new dijit.Menu(params,document.createElement("div"));

	var menuItem = new dijit.MenuItem({
        label: "Loading...",
        id: "fightMenuLoading_[% character.id %]",
    });
    menu.addChild(menuItem);

    var button[% character.id %] = new dijit.form.DropDownButton({
        label: '',
        dropDown: menu,
        class: "actionButton",
        id: "fightButton_[% character.id %]"         
	});        

    dojo.byId("fightSpan_[% character.id %]").appendChild(button[% character.id %].domNode);
    dojo.connect(dijit.byId("fightMenu_[% character.id %]"), 'onOpen', null, function() { loadFightMenu('[% character.id %]') });
    
    [% IF character.is_spell_caster %]
    	var params = {id:"castMenu_[% character.id %]" };
    	var menu = new dijit.Menu(params,document.createElement("div"));
    	
		var menuItem = new dijit.MenuItem({
	        label: "Loading...",
	        id: "castMenuLoading_[% character.id %]",
	    });
	    menu.addChild(menuItem);   
	    
	    var button[% character.id %] = new dijit.form.DropDownButton({
	        label: '<img id="castOff_[% character.id %]" src="[% c.config.static_path %]/images/actions/cast.png">' + 
	               '<img id="castOn_[% character.id %]"  style="display: none" src="[% c.config.static_path %]/images/actions/cast_glow.png">',
	        dropDown: menu,
	        class: "actionButton",
	        id: "castButton_[% character.id %]"         
		});
		
		dojo.byId("castSpan_[% character.id %]").appendChild(button[% character.id %].domNode);
    	dojo.connect(dijit.byId("castMenu_[% character.id %]"), 'onOpen', null, function() { loadCastMenu('[% character.id %]') });
		
    [% END %]
    
    [% END %]

}

dojo.addOnLoad( createMenus );
</script>

<div style=""> 

<table [% UNLESS in_combat %]dojoType="dojo.dnd.Source"[% END %] 
	id="party-table" accept="character" moveOnly="true" class="main" align="center" cellspacing=0 cellpadding=2 border=0>

	<tr>
		<td colspan="8">
		[% IF party.party_effects %]
		Party Effects: 
			[% FOREACH effect IN party.party_effects %]
				[% effect.effect.effect_name %] ([% FILTER inflect %]NO([% effect.effect.time_type %], [% effect.effect.time_left %])[% END %] left )
				[% UNLESS loop.last %],[% END %]
			[% END %]
		<br>
		[% END %] 
		<br>
		</td>
	</tr>
		
	
<tr>
	<td colspan="8">
		<h3>Party Members</h3>
	</td>
</tr>
<tr>
	[% INCLUDE party/party_list_header.html %]
	<th>Effects</th>
</tr>

[% FOREACH char IN characters %]
[% char_id = char.id %]

<tr 
	[% UNLESS in_combat %]class="dojoDndItem"[% END %] 
	dndType="character" 
	accept="character"
	id="char-[% char.id %]" 
	jsId="char-[% char.id %]" 
	[% IF char.is_dead %]style="background: black"[% END %]
>	
	[% INCLUDE party/party_list_char_line.html %]
    <td nowrap="nowrap">[% FOREACH effect IN char.character_effects %][% effect.effect.effect_name %] ([% effect.effect.time_left %])[% UNLESS loop.last() %],[% END %][% END %]</td>

	<td align="center">
    [% UNLESS char.is_dead %]
		<div id="char_action_holder_[% char.id %]" class="main"></div>    
	[% ELSE %]
		[% UNLESS in_combat %]
			<button dojoType="dijit.form.Button" onclick="buryDiag('[% char.character_name | replace("'","\\'") %]', '[% char.character_id %]')">Bury</button>
		[% END %]
    [% END %]

	</td>

    [% IF in_combat %]
    	<td>
    		<span onClick="selectActionCombat('Attack', '[% char.id %]')" style="cursor: pointer; margin-right: 0px">
    			<img id="attackOff_[% char.id %]" src="[% c.config.static_path %]/images/actions/attack.png"> 
        	    <img id="attackOn_[% char.id %]" style="display: none" src="[% c.config.static_path %]/images/actions/attack_glow.png">
        	</span>
        	<span id="fightSpan_[% char.id %]"></span>
        </td>
        <td>    		    	
    		<span onClick="selectActionCombat('Defend', '[% char.id %]')" style="cursor: pointer;">
    			<img id="defendOff_[% char.id %]" style="padding-top: 2px" src="[% c.config.static_path %]/images/actions/defend.png">
    			<img id="defendOn_[% char.id %]" style="padding-top: 2px; display: none" src="[% c.config.static_path %]/images/actions/defend_glow.png">
    		</span>
    	</td>
    	<td>
    		<span id="castSpan_[% char.id %]"></span>
    	</td>
    	<td>
    		<img src="[% c.config.static_path %]/images/actions/use.png">
    	</td>
    [% END %]

    [% IF party.rank_separator_position == char.party_order %]
    	</tr>
    	<tr>
    		<tr [% UNLESS in_combat %]class="dojoDndItem"[% END %] dndType="separator" id="rank_separator" jsId="rank_separator">
    			<td colspan="10"></td>
    [% END %]
   
</tr>
[% END %]

</table>
</div>