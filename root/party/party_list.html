<script>
function selectAction(action, char_id) {
	dijit.byId('char_action_button_' + char_id).setLabel(action);

	dojo.xhrGet( { //
	        // The following URL must match that used to test the server.
	        url: "[% base %]/combat/select_action?action=" + action + "&character_id=" + char_id, 
	        handleAs: "text",
	
	        timeout: 5000, // Time in milliseconds
	
	        });
	        
	return false;
}

        dojo.require("dojo.dnd.Source");
        dojo.require("dijit.Menu");
        dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
			var t = dojo.dnd.manager().target;

	    	order_val = nodes[0].id.split(/-/);
			var char_1 = order_val[1];
			
			order_val = t.current.id.split(/-/);
			var char_2 = order_val[1];

			var drop_pos;
			(t.before == true) ? drop_pos='before' : drop_pos='after';

	    	dojo.xhrGet( {
		        url: "[% base %]/party/swap_chars?moved=" + char_1 + "&target=" + char_2 + "&drop_pos=" + drop_pos, 
		        handleAs: "text",
	
	    	    timeout: 5000, // Time in milliseconds	
	        });
		});
        
</script>

<style>
.dojoDndItemBefore {border-left: 2px dotted gray; } 

.dojoDndItemAfter {border-right: 2px dotted gray; }

.dijitButtonText { font-size: 10pt }

#char-1 {
	border: 5px solid black;
}

</style>

<table dojoType="dojo.dnd.Source"jsId="c[% char.id %]" accept="character" moveOnly="true">
<tr>
    <th>Name</th>
    <th>Race</th>
    <th>Class</th>
    <th>HP</th>
    <th>XP</th>
    <th>S</th>
    <th>I</th>
    <th>A</th>        
    <th>D</th>
    <th>C</th>        
</tr>

[% FOREACH char = characters %]
<tr class="dojoDndItem" dndType="character" id="char-[% char.id %]" jsId="char-[% char.id %]">
    <td><a href="[% base %]/character/view?character_id=[% char.character_id %]">[% char.character_name %]</a></td>
    <td>[% char.race.race_name %]</td>
    <td>[% char.class.class_name %]</td>
    <td>[% char.hit_points %] / [% char.max_hit_points %]</td>
    <td>[% char.xp %]</td>
    <td>[% char.strength %]</td>
    <td>[% char.intelligence %]</td>
    <td>[% char.agility %]</td>
    <td>[% char.divinity %]</td>
    <td>[% char.constitution %]</td>
    
    [% IF party.in_combat_with && ! char.is_dead %]
    	<td>
        <div dojoType="dijit.form.DropDownButton" id="char_action_button_[% char.id %]">
             <span>[% char.last_combat_action %]</span>
    	     <div dojoType="dijit.Menu" style="display: none">
	         <div dojoType="dijit.MenuItem" onClick="selectAction('Attack', '[% char.id %]');">Attack</div>
	         <div dojoType="dijit.MenuItem" onClick="selectAction('Defend', '[% char.id %]');">Defend</div>	        
             <!--<div dojoType="dijit.PopupMenuItem">
	             <span>Submenu</span>
	             <div dojoType="dijit.Menu">
		             <div dojoType="dijit.MenuItem" onClick="alert('Submenu 1!')">Submenu Item One</div>
		             <div dojoType="dijit.MenuItem" onClick="alert('Submenu 2!')">Submenu Item Two</div>
	            </div>
	         -->
	        </div>
            </div>
        </div>
		</td>
    [% END %]
</tr>
[% END %]
</table>