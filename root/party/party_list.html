<script>
function selectAction(action, char_id, action_param, action_param2, action_label) {
	if (! action_label) {
		action_label = action;
	}
	
	if (! action_param) {
		action_param = '';
	}

	dijit.byId('char_action_button_' + char_id).setLabel(action_label);

	dojo.xhrGet( { //
	        // The following URL must match that used to test the server.
	        url: "[% base %]/combat/select_action?action=" + action + "&character_id=" + char_id + "&action_param=" + action_param +
		        "&action_param=" + action_param2, 
	        handleAs: "text",
	
	        timeout: 5000, // Time in milliseconds
	
	        });
	        
	return false;
}

        dojo.require("dojo.dnd.Source");
        dojo.require("dijit.Menu");
        dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
			var t = dojo.dnd.manager().target;

			order_val = t.current.id.split(/-/);
			var char_2 = order_val[1];

			var drop_pos;
			(t.before == true) ? drop_pos='before' : drop_pos='after';
			
			if (nodes[0].id == 'rank_separator') {
		    	dojo.xhrGet( {
			        url: "[% base %]/party/move_rank_separator?target=" + char_2 + "&drop_pos=" + drop_pos, 
			        handleAs: "text",
		
		    	    timeout: 5000, // Time in milliseconds	
		        });			
			}
			else {
		    	order_val = nodes[0].id.split(/-/);
				var char_1 = order_val[1];
				
		    	dojo.xhrGet( {
			        url: "[% base %]/party/swap_chars?moved=" + char_1 + "&target=" + char_2 + "&drop_pos=" + drop_pos, 
			        handleAs: "text",
		
		    	    timeout: 5000, // Time in milliseconds	
		        });
		    }
		});
        
</script>

<style>
.dojoDndItemBefore {border-left: 2px dotted gray; } 

.dojoDndItemAfter {border-right: 2px dotted gray; }

.dijitButtonText { font-size: 10pt }

#rank_separator {
	background: #000;
	height: 5px;
}

</style>

<table dojoType="dojo.dnd.Source" id="party-table" accept="character" moveOnly="true" class="main">
<tr>
    <th>Name</th>
    <th>Race</th>
    <th>Class</th>
    <th>Level</th>
    <th>HP</th>
    <th>XP</th>
    <th>Effects</th>

</tr>

[% FOREACH char = characters %]
[% char_id = char.id %]
<tr class="dojoDndItem" dndType="character" id="char-[% char.id %]" jsId="char-[% char.id %]" [% IF char.is_dead %]style="background: grey"[% END %]>
    <td><a href="[% base %]/character/view?character_id=[% char.character_id %]">[% char.character_name %]</a></td>
    <td>[% char.race.race_name %]</td>
    <td>[% char.class.class_name %]</td>
    <td align="center">[% char.level %]</td>
    <td>[% IF char.is_dead %]Dead[% ELSE %][% char.hit_points %] / [% char.max_hit_points %][% END %]</td>
    <td>[% char.xp %]</td>
    <td>[% FOREACH effect IN char.character_effects %][% effect.effect.effect_name %][% UNLESS loop.last() %],[% END %][% END %]</td>
    
    [% IF party.in_combat_with && ! char.is_dead %]
    	<td>
        <div dojoType="dijit.form.DropDownButton" id="char_action_button_[% char.id %]">
             <span>[% char.last_combat_action %]</span>
    	     <div dojoType="dijit.Menu" style="display: none">
		         <div dojoType="dijit.MenuItem" onClick="selectAction('Attack', '[% char.id %]');">Attack</div>
		         <div dojoType="dijit.MenuItem" onClick="selectAction('Defend', '[% char.id %]');">Defend</div>	        
	             <div dojoType="dijit.PopupMenuItem">
		             <span>Target</span>
		              <div dojoType="dijit.Menu">
						 [% FOREACH creature IN creatures %]
						 	[% UNLESS creature.is_dead %]
				            <div dojoType="dijit.MenuItem" onClick="selectAction('Attack', '[% char.id %]', '[% creature.id %]', '', 'Targetting: [% creature.name %]')">[% creature.name %]</div>
				            [% END %]
				         [% END %]
				    </div>
		        </div>
		        [% IF spells.$char_id %]
		        [% character_spells = spells.$char_id %]
	             <div dojoType="dijit.PopupMenuItem">
		             <span>Cast</span>
		             <div dojoType="dijit.Menu">
						 [% FOREACH memorised_spell IN character_spells %]
						    [% spell = memorised_spell.spell %]
						 	[% IF spell.target == 'character' || spell.target == 'creature' %]
						    	<div dojoType="dijit.PopupMenuItem">
  					             <span>[% spell.spell_name %]</span>
					             <div dojoType="dijit.Menu">
  					             [% IF spell.target == 'creature' %]
									 [% FOREACH creature IN creatures %]
									 	[% UNLESS creature.is_dead %]
							            <div dojoType="dijit.MenuItem" 
							            	onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '[% creature.id %]', 
							            		'Casting [% spell.spell_name %] on: [% creature.name %]')">[% creature.name %]</div>
							            [% END %]
							         [% END %]
								 [% ELSE %]
    								 [% FOREACH character IN characters %]
									 	[% UNLESS character.is_dead %]
							            <div dojoType="dijit.MenuItem" 
							            	onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '[% character.id %]', 
							            		'Casting [% spell.spell_name %] on: [% character.name %]')">[% character.name %]</div>
							            [% END %]
							         [% END %]
								 [% END %]
						 	     </div>
						 	     </div>
  					             
						 	[% ELSE %]
				            <div dojoType="dijit.MenuItem" onClick="selectAction('Cast','[% char.id %]', '[% spell.id %]', '', 
							            		'Casting [% spell.spell_name %]">[% spell.spell_name %]</div>
				            [% END %]
			             [% END %]
		            </div>
		        </div>
		        [% END %]

            </div>            
            
        </div>
		</td>
    [% END %]
    
    [% IF party.rank_separator_position == char.party_order %]
    	</tr>
    	<tr>
    		<tr class="dojoDndItem" dndType="character" id="rank_separator" jsId="rank_separator">
    			<td colspan="10"></td>
    [% END %]
</tr>
[% END %]
</table>