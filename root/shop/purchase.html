[% INCLUDE top.html %]

<script type="text/javascript">
	dojo.require("dojo.dnd.Source");
	dojo.require("dijit.form.NumberSpinner");

	dojo.declare("rpg.dnd.Target", dojo.dnd.Target, {
        onDndDrop: function(source, nodes, copy){
				if(this.containerState == "Over"){ // dropping on us
					source.delItem('dojoUnique1'); // delete the copied item
			    }
			    this.onDndCancel();  // cleanup the drop state
		},
			 
		markupFactory: function(params, node){
		    params._skipStartup = true;
		    return new rpg.dnd.Target(node, params);
		}
		
    });
	
function init() {	
	dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
		var t = dojo.dnd.manager().target;

		var purchasedItem = source.getItem(nodes[0].id).data;

		tmp = t.node.id.split(/-/);
		var char_id = tmp[2];
	
		var purchasingChar = tmp[1];
		
    	tmp = nodes[0].id.split(/-/);
		
		if (tmp[0] == 'item') {
			var item_id = tmp[1];	
			
			dojo.byId('confirmation-message').innerHTML = "Are you sure you want to purchase a " + purchasedItem + " for " + purchasingChar + "?";
			dojo.byId('purchasing-char-id').value = char_id;
			dojo.byId('purchasing-item-id').value = item_id;
			
			dijit.byId('confirmation').show();
		}
		else if (tmp[0] == 'item_type') {
			var item_type_id = tmp[1];

			dojo.byId('quantity-selection-message').innerHTML = "Select how many " + purchasedItem + " you'd like to buy for " + purchasingChar;
			dojo.byId('quantity-char-id').value = char_id;
			dojo.byId('quantity-item-type-id').value = item_type_id;
			
			dijit.byId('quantity-selection').show();
		}
		else {
			alert("Invalid drag/drop");
		}
		
		return true;
	});	
}

function savePurchase(dialogFields) {	
	dojo.xhrGet( {
        url: "[% base %]/shop/buy_item?character_id=" + dialogFields.purchasing_char_id 
        	+ "&item_id=" + dialogFields.purchasing_item_id
        	+ "&shop_id=[% shop.id %]", 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
  	  	  //console.log(responseObject);
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;
			  dojo.byId('item-quantity-' + responseObject.updated_stock.item_type).innerHTML = responseObject.updated_stock.count;
			  
			  if (responseObject.updated_stock.count == 0) {
			  	dojo.byId('item-source-' + responseObject.updated_stock.item_type).innerHTML = 
			  		dojo.byId('item-' + dialogFields.purchasing_item_id).innerHTML;
			  }
			  else {
			  	//console.log(dialogFields.purchasing_item_id);
				dojo.byId('item-' + dialogFields.purchasing_item_id).id = 'item-' + responseObject.updated_stock.next_item;
		  	  }		  	  
		  }
          return responseObject;
        },

	    timeout: 5000 // Time in milliseconds	
    });
    	
	return true;
}

function saveQuantityPurchase(dialogFields) {	
	dojo.xhrGet( {
        url: "[% base %]/shop/buy_quantity_item?character_id=" + dialogFields.purchasing_char_id 
        	+ "&item_type_id=" + dialogFields.purchasing_item_type_id + "&shop_id=[% shop.id %]"
        	+ "&quantity=" + dialogFields.quantity, 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;		  
		  }
          return responseObject;
        },

	    timeout: 5000 // Time in milliseconds	
    });
    	
	return true;
}

function sellItemConfirm(item_type, item_id, sell_price, equip_place_id) {
	var message = "Are you sure you want to sell " + item_type + " for " + sell_price + " gold?";

	if (equip_place_id != "" && equip_place_id != 0) {
		message += " (Note, this item is currently equipped)";
	}
	
	dojo.byId('confirm-sale-message').innerHTML = message;
	dojo.byId('item-to-sell').value = item_id;
	dijit.byId('confirm-sale').show();
}

function sellItem(dialogFields) {
	dojo.xhrGet( {
        url: "[% base %]/shop/sell_item?item_id=" + dialogFields.item_id + "&shop_id=[% shop.id %]", 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;
		  }
          return responseObject;
        },

	    timeout: 5000 // Time in milliseconds	
    });
}

dojo.addOnLoad( init );
	
</script>

<div dojoType="dijit.Dialog" id="confirmation" style="display: none" title="Confirm Purchase" execute="savePurchase(arguments[0]);">
    <span id="confirmation-message"></span>
    <input id="purchasing-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="purchasing-item-id" name="purchasing_item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
    <!-- <button dojoType=dijit.form.Button onClick="dijit.byId('confirmation').hide()">Cancel</button> -->
</div>

<div dojoType="dijit.Dialog" id="quantity-selection" style="display: none" title="Select Quantity" execute="saveQuantityPurchase(arguments[0]);">
    <span id="quantity-selection-message"></span>
    <input id="quantity-spinner" type="text"
        dojoType="dijit.form.NumberTextBox"
        name= "quantity"
        value="1"
        constraints="{min:1,max:1000,places:0}"
        promptMessage= "Enter a value between 1 and 1000"
        required= "true"
        invalidMessage= "Invalid quantity."
        />
    <input id="quantity-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="quantity-item-type-id" name="purchasing_item_type_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>

<div dojoType="dijit.Dialog" id="confirm-sale" style="display: none" title="Confirm Sale" execute="sellItem(arguments[0]);">
    <span id="confirm-sale-message"></span>
    <input id="item-to-sell" name="item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
    <button dojoType=dijit.form.Button>Cancel</button>
</div>

<h1>[% shop.shop_name %]</h1>

<br><br>

Shops in [% town.town_name %]: 
[% FOREACH other_shop IN shops_in_town %]
	[% UNLESS shop.id == other_shop.id %]<a href="[% base %]/shop/purchase?shop_id=[% other_shop.id %]">[% END %]
		[% other_shop.shop_name %][% UNLESS shop.id == other_shop.id %]</a>[% END %]&nbsp;
[% END %]
<br><br>

[% IF shop.status == 'Open' %]
	[% shop.shop_owner_name %] welcomes you to his humble store. "I hope you find what you're looking for!"
[% ELSIF shop.status == 'Opening' %]
	[% shop.shop_owner_name %] greets you. "My brand bew shop is only just opening! Come back soon for a fine selection of equipment"
[% ELSIF shop.status == 'Closing' %]
	You notice a sign on the wall: "[% shop.shop_owner_name %] regrets to inform you that his shop will soon be closing down due to 
	a downturn in the local economy. He'd like to thank all his loyal customers from years gone by".
[% ELSIF shop.status == 'Closed' %]
	There doesn't seem to be anyone here. The shop appears to be closed.
[% END %]
<br><br>

<!-- Yes this layout is *really* messed up. Will fix it one day -->
<div align="center">Drag an item from the right onto a character's name to purchase it</div>
<div align="center">Party Gold: <span id="current-gold">[% gold %]</span></div>
<table class="main" border="0" align="center">
<tr><td valign="top">
<table class="main" border="0">
[%  FOREACH char = characters %]
<tr><td>
<div id="char_[% char.character_id %]">
<span dojoType="rpg.dnd.Target" jsId="t[% char.character_id %]" id="char-[% char.character_name %]-[% char.character_id %]" 
	class="target" accept="item" style="width: 70%;">
		[% char.character_name %]
</span>
</td><td>

<span dojoType="dijit.form.DropDownButton">
        <span>Equipment</span>
        <div dojoType="dijit.TooltipDialog" id="equip_[% char.character_id %]" style="display: none" refreshOnShow="true"
        	href="[% base %]/character/equipment_list?character_id=[% char.id %]&shop_id=[% shop_id %]">
        </div>
</span>
<span id="char_items_[% char.character_id %]" style="visibility: hidden; border: 1px dotted black"><span>

</div>
</td></tr>

[% END %]
</table>

</td><td width="40">&nbsp;</td><td valign="top">

[% MACRO item_details(item_type) BLOCK %]
<td>
	<span dojoType="dijit.form.DropDownButton">
	        <span>?</span>
	        <div dojoType="dijit.TooltipDialog" style="display: none"
	        	href="[% base %]/item/tooltip?item_type_id=[% item_type.id %]">
	        </div>
	</span>
</td>
[% END %]

<table id="main" border="0" cellpadding="6">
[% last_category = '' %]
[% FOREACH category IN items %]
	[% IF last_category != category.key %]
		<tr><td colspan="2"><b>[% category.key %]</b></td></tr>
		[% last_category = category.key %]
	[% END %]
	
	[% FOREACH item_or_type IN category.value %]
		[% IF item_or_type.key == 'item' %]
			[% FOREACH item IN item_or_type.value %]
			<tr>
				<td>
					<span id="item-quantity-[% item.item_type.id %]">[% item.get_column('number_of_items') %]</span> x
					<span dojoType="dojo.dnd.Source" class="source" copyOnly="true" id="item-source-[% item.item_type.id %]">
						<span class="dojoDndItem" dndType="item" id="item-[% item.item_id %]" dndData="[% item.item_type.item_type %]">[% item.item_type.item_type %]</span>
					</span>	
					([% item.item_type.modified_cost(shop) %] gold)
				</td>
				[% item_details(item.item_type) %]
			</tr>
			[% END %]
		[% ELSE %]
			[% FOREACH item_type IN item_or_type.value %]
			<tr>
				<td>
					<span dojoType="dojo.dnd.Source" class="source" copyOnly="true" id="item-type-source-[% item_type.id %]">
						<span class="dojoDndItem" dndType="item" id="item_type-[% item_type.id %]" dndData="[% item_type.item_type %]">[% item_type.item_type %]</span>
					</span>					
					([% item_type.modified_cost(shop) %] gold each)
				</td>
				[% item_details(item.item_type) %]
			</tr>
			[% END %]
		[% END %]
	[% END %]				
[% END %]	
</table>

</td></tr></table>

[% INCLUDE bottom.html %]