[% PROCESS layout/diag_buttons.html %]

<script type="text/javascript">

function init() {	
	dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
		var t = dojo.dnd.manager().target;
	
    	tmp = nodes[0].id.split(/-/);
    	var purchaseType = tmp[1];    	
    	var item_type_id = tmp[2];
    	
    	if (! item_type_id || ! tmp[0] == 'shop') {
    		return;
    	}
    	
		var purchasedItem = source.getItem(nodes[0].id).data;
		
		if (! purchasedItem) {
			return;
		}

		tmp = t.node.id.split(/-/);
		var char_id = tmp[1];
	
		var purchasingChar = dojo.byId(t.node.id).innerHTML;		

		
		if (purchaseType == 'item' || purchaseType == 'enchanted') {			
			dojo.byId('equip-purchase-confirmation-message').innerHTML =  "Are you sure you want to purchase a " + purchasedItem + " for " + purchasingChar + "?";
			dojo.byId('purchasing-char-id').value = char_id;
			
			if (purchaseType == 'item') {
			    dojo.byId('purchasing-item-id').value = '';
				dojo.byId('purchasing-item-type-id').value = item_type_id;
			}
			else {
				dojo.byId('purchasing-item-id').value = item_type_id;
				dojo.byId('purchasing-item-type-id').value = '';
			}
			
			dijit.byId('equip-purchase-confirmation').show();
		}
		else if (purchaseType == 'quantity') {
			dojo.byId('quantity-selection-message').innerHTML = "Select how many " + purchasedItem + " you'd like to buy for " + purchasingChar;
			dojo.byId('quantity-char-id').value = char_id;
			dojo.byId('quantity-item-type-id').value = item_type_id;
			
			dijit.byId('quantity-selection').show();
		}
		else {
			console.error("Invalid drag/drop");
			return;
		}
		
		return true;
	});	
}

function savePurchase(dialogFields) {
	if (dialogFields.purchasing_item_id) {
		url = "shop/buy_item?item_id=" + dialogFields.purchasing_item_id;
	}
	else {
		url = "shop/buy_item?item_type_id=" + dialogFields.purchasing_item_type_id;
	}
	
	url += "&character_id=" + dialogFields.purchasing_char_id 
		+  "&shop_id=[% shop.id %]";

	getPanels(url);
}

function saveQuantityPurchase(dialogFields) {	
	var url = "shop/buy_quantity_item?character_id=" + dialogFields.purchasing_char_id 
        	+ "&item_type_id=" + dialogFields.purchasing_item_type_id + "&shop_id=[% shop.id %]"
        	+ "&quantity=" + dialogFields.quantity;

	getPanels(url);
}

function purchaseCallback(data) {
	dijit.byId(data.tab).refresh();
}

dojo.addOnLoad( init );

</script>

<div dojoType="dijit.Dialog" id="equip-purchase-confirmation" style="display: none" title="Confirm Purchase" execute="savePurchase(arguments[0]);">
    <span id="equip-purchase-confirmation-message"></span>
    <input id="purchasing-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="purchasing-item-type-id" name="purchasing_item_type_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="purchasing-item-id" name="purchasing_item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	[% dialog_buttons('equip-purchase-confirmation') %]
</div>

<div dojoType="dijit.Dialog" id="quantity-selection" style="display: none" title="Select Quantity" execute="saveQuantityPurchase(arguments[0]);">
    <span id="quantity-selection-message"></span>
    <input id="quantity-spinner" type="text"
        dojoType="dijit.form.NumberTextBox"
        name= "quantity"
        value="1"
        constraints="{min:1,max:1000,places:0}"
        promptMessage= "Enter a value between 1 and 1000"
        required= "true"
        invalidMessage= "Invalid quantity."
		style="width: 80px"
        />
    <input id="quantity-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="quantity-item-type-id" name="purchasing_item_type_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
	[% dialog_buttons('quantity-selection') %]
</div>

<div dojoType="dijit.Dialog" id="message-diag" style="display: none" title="Message">
    <span id="message-text"></span>
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>


[% INCLUDE shop/header.html shop_link='shop/purchase' %]

<div align="center">
<h3>Buy Items</h3>
	
[% FOREACH char = characters %]
<span style="padding: 5px">
	<span dojoType="rpg.dnd.Target" jsId="t[% char.character_id %]" id="char-[% char.character_id %]" 
		class="target" accept="item" style="width: 70%;">
			[% char.character_name %]
	</span>
</span>
[% END %]
</div>

<br><br>
<div align="center">Drag an item below onto a character's name to purchase it</div>
<br>


<div class="kingdomsTabContainer" dojoType="dijit.layout.TabContainer">
		<div id="standard" dojoType="dijit.layout.ContentPane" title="Standard Items"
			href="[% base %]/shop/standard_tab?shop_id=[% shop.id %]">

		</div>

[% IF shop.has_enchanted_items %]
	<div id="enchanted" dojoType="dijit.layout.ContentPane" title="Enchanted & Upgraded Items"
		href="[% base %]/shop/enchanted_tab?shop_id=[% shop.id %]">
	</div>
[% END %]
</div>	