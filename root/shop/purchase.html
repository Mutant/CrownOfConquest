[% INCLUDE top.html %]

<script type="text/javascript">
	dojo.require("dojo.dnd.Source");
	dojo.require("dijit.form.NumberSpinner");

	dojo.declare("rpg.dnd.Target", dojo.dnd.Target, {
        onDndDrop: function(source, nodes, copy){
				if(this.containerState == "Over"){ // dropping on us
					source.delItem('dojoUnique1'); // delete the copied item
			    }
			    this.onDndCancel();  // cleanup the drop state
		},
			 
		markupFactory: function(params, node){
		    params._skipStartup = true;
		    return new rpg.dnd.Target(node, params);
		},
		
    });
	
function init() {	
	dojo.subscribe("/dnd/drop", function(source,nodes,iscopy){
		var t = dojo.dnd.manager().target;

		var purchasedItem = source.getItem(nodes[0].id).data;

		tmp = t.node.id.split(/-/);
		var char_id = tmp[2];
	
		var purchasingChar = tmp[1];
		
    	tmp = nodes[0].id.split(/-/);
		
		if (tmp[0] == 'item') {
			var item_id = tmp[1];	
			
			dojo.byId('confirmation-message').innerHTML = "Are you sure you want to purchase a " + purchasedItem + " for " + purchasingChar;
			dojo.byId('purchasing-char-id').value = char_id;
			dojo.byId('purchasing-item-id').value = item_id;
			
			dijit.byId('confirmation').show();
		}
		else if (tmp[0] == 'item_type') {
			var item_type_id = tmp[1];

			dojo.byId('quantity-selection-message').innerHTML = "Select how many " + purchasedItem + " you'd like to buy for " + purchasingChar;
			dojo.byId('quantity-char-id').value = char_id;
			dojo.byId('quantity-item-type-id').value = item_type_id;
			
			dijit.byId('quantity-selection').show();
		}
		else {
			alert("Invalid drag/drop");
		}
		
		return true;
	});	
}

function savePurchase(dialogFields) {	
	dojo.xhrGet( {
        url: "[% base %]/shop/buy_item?character_id=" + dialogFields.purchasing_char_id + "&item_id=" + dialogFields.purchasing_item_id, 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;
			  dojo.byId('item-count-' + responseObject.updated_stock.item_type).innerHTML = responseObject.updated_stock.count;
			  
			  if (responseObject.updated_stock.count == 0) {
			  	dojo.byId('item-source-' + responseObject.updated_stock.item_type).innerHTML = 
			  		dojo.byId('item-' + dialogFields.purchasing_item_id).innerHTML;
			  }
			  else {			  
				dojo.byId('item-' + dialogFields.purchasing_item_id).id = 'item-' + responseObject.updated_stock.next_item;
		  	  }		  	  
		  }
          return responseObject;
        },

	    timeout: 5000, // Time in milliseconds	
    });
    	
	return true;
}

function saveQuantityPurchase(dialogFields) {	
	dojo.xhrGet( {
        url: "[% base %]/shop/buy_quantity_item?character_id=" + dialogFields.purchasing_char_id 
        	+ "&item_type_id=" + dialogFields.purchasing_item_type_id + "&shop_id=[% shop.id %]"
        	+ "&quantity=" + dialogFields.quantity, 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;		  
		  }
          return responseObject;
        },

	    timeout: 5000, // Time in milliseconds	
    });
    	
	return true;
}

function sellItemConfirm(item_type, item_id, sell_price) {
	dojo.byId('confirm-sale-message').innerHTML = "Are you sure you want to sell " + item_type + " for " + sell_price + " gold?";
	dojo.byId('item-to-sell').value = item_id;
	dijit.byId('confirm-sale').show();
}

function sellItem(dialogFields) {
	dojo.xhrGet( {
        url: "[% base %]/shop/sell_item?item_id=" + dialogFields.item_id + "&shop_id=[% shop.id %]", 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) {
          if (responseObject.error) {
          	dojo.byId('error-message').innerHTML = responseObject.error;
          	dijit.byId('error').show();
          }
          else if (responseObject.gold) {
			  dojo.byId('current-gold').innerHTML = responseObject.gold;
		  }
          return responseObject;
        },

	    timeout: 5000, // Time in milliseconds	
    });
}

dojo.addOnLoad( init );
	
</script>

<div dojoType="dijit.Dialog" id="confirmation" style="display: none" title="Confirm Purchase" execute="savePurchase(arguments[0]);">
    <span id="confirmation-message"></span>
    <input id="purchasing-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="purchasing-item-id" name="purchasing_item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
    <button dojoType=dijit.form.Button>Cancel</button>
</div>

<div dojoType="dijit.Dialog" id="quantity-selection" style="display: none" title="Select Quantity" execute="saveQuantityPurchase(arguments[0]);">
    <span id="quantity-selection-message"></span>
    <input dojoType="dijit.form.NumberSpinner"
                value="1"
                size="5"
                smallDelta="10"
                constraints="{min: 1}"
                maxlength="5"
                id="quantity-spinner"
                name="quantity">
    <input id="quantity-char-id" name="purchasing_char_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <input id="quantity-item-type-id" name="purchasing_item_type_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
</div>

<div dojoType="dijit.Dialog" id="confirm-sale" style="display: none" title="Confirm Sale" execute="sellItem(arguments[0]);">
    <span id="confirm-sale-message"></span>
    <input id="item-to-sell" name="item_id" dojoType=dijit.form.TextBox type="hidden" style="display: none" value="">
    <button dojoType=dijit.form.Button type="submit">OK</button>
    <button dojoType=dijit.form.Button>Cancel</button>
</div>

<h1>[% shop.shop_name %]</h1>

Shops in town: 
[% FOREACH other_shop IN shops_in_town %]
	[% UNLESS shop.id == other_shop.id %]<a href="[% base %]/shop/purchase?shop_id=[% other_shop.id %]">[% END %]
		[% other_shop.shop_name %][% UNLESS shop.id == other_shop.id %]</a>[% END %]&nbsp;
[% END %]
<br>
[%  FOREACH char = characters %]
<div id="char_[% char.character_id %]">
<span dojoType="rpg.dnd.Target" jsId="t[% char.character_id %]" id="char-[% char.character_name %]-[% char.character_id %]" class="target" accept="item">
		[% char.character_name %]
</span>

<span dojoType="dijit.form.DropDownButton">
        <span>Equipment</span>
        <div dojoType="dijit.TooltipDialog" id="equip_[% char.character_id %]" style="display: none" refreshOnShow="true"
        	href="[% base %]/character/equipment_list?character_id=[% char.id %]&shop_id=[% shop_id %]">
        </div>
</span>

<span id="char_items_[% char.character_id %]" style="visibility: hidden; border: 1px dotted black"><span>

</div><br>
[% END %]

Current Gold: <span id="current-gold">[% gold %]</span>

<br><br>

<table id="items-table" border="1">
[% last_category = '' %]
[% FOREACH category IN items %]
	[% IF last_category != category.key %]
		<tr><td colspan="3"><b>[% category.key %]</b></td></tr>
		<tr><td>Number Available</td><td>Item</td><td>Cost</td></tr>
		[% last_category = category.key %]
	[% END %]
	
	[% FOREACH item_or_type IN category.value %]
		[% IF item_or_type.key == 'item' %]
			[% FOREACH item IN item_or_type.value %]
			<tr>
				<td id="item-count-[% item.item_type.id %]">[% item.get_column('number_of_items') %]</td>
				<td>
					<span dojoType="dojo.dnd.Source" class="source" copyOnly="true" id="item-source-[% item.item_type.id %]">
						<span class="dojoDndItem" dndType="item" id="item-[% item.item_id %]" dndData="[% item.item_type.item_type %]">[% item.item_type.item_type %]</span>
					</span>	
				</td>
				<td>[% item.item_type.modified_cost(shop) %]</td>
			</tr>
			[% END %]
		[% ELSE %]
			[% FOREACH item_type IN item_or_type.value %]
			<tr>
				<td>[ N/A ]</td>
				<td>
					<span dojoType="dojo.dnd.Source" class="source" copyOnly="true" id="item-type-source-[% item_type.id %]">
						<span class="dojoDndItem" dndType="item" id="item_type-[% item_type.id %]" dndData="[% item_type.item_type %]">[% item_type.item_type %]</span>
					</span>					
				</td>
				<td>[% item_type.modified_cost(shop) %]</td>
			</tr>
			[% END %]
		[% END %]
	[% END %]				
[% END %]	
</table>

[% INCLUDE bottom.html %]