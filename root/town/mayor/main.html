[% INCLUDE top.html %]

[% PROCESS town/mayor/display_approval.html %]

<script>
    dojo.require("dijit.form.Form");
    dojo.require("dijit.form.Button");
	dojo.require("dijit.form.NumberTextBox");
	dojo.require("dijit.layout.TabContainer");
	dojo.require("dijit.layout.ContentPane");
	
function changeGold(townGoldInput) {
	dojo.xhrGet( {
        url: "[% base %]/town/mayor/change_gold?town_id=[% town.id %]&town_gold=" + townGoldInput.value, 
        handleAs: "json",
        
        load: function(responseObject, ioArgs) { 
        	dojo.byId('party_gold').innerHTML = responseObject.party_gold;
        	if (townGoldInput.value != responseObject.town_gold) {
        		townGoldInput.value = responseObject.town_gold;
        	}
        },
		timeout: 5000
    }); 
}	

var base_cost = [% town.base_party_tax %];
var level_step = [% town.party_tax_level_step %];
function updateTaxPreviewBase(input) {
	if (base_cost == input.value) { return }
	base_cost = input.value;
	refreshTaxPreview();
}

function updateTaxPreviewLevelStep(input) {
	if (level_step == input.value) { return }
	level_step = input.value;
	refreshTaxPreview();
}

function refreshTaxPreview() {
	url = '[% base %]/town/mayor/party_tax_preview?town_id=[% town_id %]';

	if (typeof base_cost  !== 'undefined')  { url += '&base_cost=' + base_cost }
	if (typeof level_step !== 'undefined')  { url += '&level_step=' + level_step };
	
	dijit.byId('party-tax-preview').href = url;
	dijit.byId('party-tax-preview').refresh();
}

</script>

<h2>[% town.town_name %] Mayor's Office</h2>

<a href="[% base %]">Back To Town</a><br><br>

[% IF party_in_town %]
	<table class="main">
		<tr>
			<td>Town Coffers:</td>
			<td><input type="text" name="town_gold" value="[% town.gold %]" size="5" onchange="changeGold(this)"></td>
		</tr>
		<tr>
			<td>Party Gold:</td>
			<td id="party_gold">[% party.gold %]</td>
		</tr>
	</table>
[% ELSE %]
	Town Coffers: [% town.gold %] gold
[% END %]
<br><br>

Approval Rating: [% display_rating(town.mayor_rating) %]<br><br>

<div id="mainTabContainer" dojoType="dijit.layout.TabContainer" style="height: 700px; overflow: auto">
	
<div dojoType="dijit.layout.ContentPane" title="Tax Settings">

<h3>Tax Settings</h3>

You can change tax settings once per day. [% IF town.tax_modified_today %]You've already changed the tax settings today.[% END %]

[% UNLESS town.tax_modified_today %]
<div dojoType="dijit.form.Form" action="[% base %]/town/mayor/update" method="POST">
[% END %]

<input type="hidden" name="town_id" value="[% town.id %]">

<table class="main">
	<tr>
		<td>Peasant Tax:</td>
		<td><input type="text" dojoType="dijit.form.NumberTextBox" name="peasant_tax" id="peasant-tax" style="width: 50px"
				value="[% town.peasant_tax %]" constraints="{min:0,max:100,places:0}" required="true"
				invalidMessage="Peasant Tax must be between 0 and 100%">%
				
			<div dojoType="dijit.Tooltip"
	           		connectId="peasant-tax"
					style="display: none">
					Percentage to tax the peasants of the town. Too high a tax may lead the peasants to rebel. 		 
			</div>					
		</td>
	</tr>
	<tr>
		<td>Sales Tax:</td>
		<td><input type="text" dojoType="dijit.form.NumberTextBox" name="sales_tax" id="sales-tax" style="width: 50px"
				value="[% town.sales_tax %]" constraints="{min:0,max:100,places:0}" required="true"
				invalidMessage="Sales Tax must be between 0 and 100%">%
				
				<div dojoType="dijit.Tooltip"
	           		connectId="sales-tax"
					style="display: none">
					Percentage to tax all sales of equipment to or from shops in the town. 		 
				</div>
		</td>
	</tr>
	<tr>
		<td>Base Party Tax:</td>
		<td><input type="text" dojoType="dijit.form.NumberTextBox" name="base_party_tax" id="base-party-tax" style="width: 50px"
				value="[% town.base_party_tax %]" constraints="{min:0,places:0}" required="true"
				invalidMessage="Base Party Tax must be 0 or more"
				onBlur="updateTaxPreviewBase(this)">
				
				<div dojoType="dijit.Tooltip"
	           		connectId="base-party-tax"
					style="display: none">
					Base amount a party must pay to enter the town, regardless of level. 		 
				</div>				
		</td>
	</tr>
	<tr>
		<td>Party Tax Per Level:</td>
		<td><input type="text" dojoType="dijit.form.NumberTextBox" name="party_tax_level_step" id="party-tax-level-step" style="width: 50px"
				value="[% town.party_tax_level_step %]" constraints="{min:0,places:0}" required="true"
				invalidMessage="Party Tax Per Level must be 0 or more"
				onBlur="updateTaxPreviewLevelStep(this)">
				
				<div dojoType="dijit.Tooltip"
	           		connectId="party-tax-level-step"
					style="display: none">
					Amount of tax a party must pay to enter the town, for each party level above 1.
				</div>					
		</td>
	</tr>
</table>

[% UNLESS town.tax_modified_today %]
<button dojoType="dijit.form.Button" type="submit" name="submitButton" value="Submit">
	Submit
</button>

</div>
[% END %]

<div dojoType="dijit.layout.ContentPane" id="party-tax-preview" href="[% base %]/town/mayor/party_tax_preview?town_id=[% town_id %]"></div>

</div>
	
<div dojoType="dijit.layout.ContentPane" title="Guards" href="[% base %]/town/mayor/guards?town_id=[% town.id %]" [% IF tab == 'guards' %]selected=true[% END %]></div>

<div dojoType="dijit.layout.ContentPane" title="Balance Sheet" href="[% base %]/town/mayor/balance_sheet?town_id=[% town.id %]&day_id=[% day_id %]" [% IF tab == 'balance_sheet' %]selected=true[% END %]></div>

<div dojoType="dijit.layout.ContentPane" title="Elections" href="[% base %]/town/mayor/elections?town_id=[% town.id %]" [% IF tab == 'elections' %]selected=true[% END %]></div>

<div dojoType="dijit.layout.ContentPane" title="News" href="[% base %]/town/mayor/news?town_id=[% town.id %]" [% IF tab == 'news' %]selected=true[% END %]></div>

[% INCLUDE bottom.html %]
